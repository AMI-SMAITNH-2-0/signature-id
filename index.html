<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Attendance Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL@24..48,100..700,0..1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add this after html2canvas script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="navbar.css">
    <style>
        :root {
            --primary: #736b23;
            --secondary: #9ade24;
            --accent: #f5de3e;
            --light: #ecf0f1;
            --dark: #0d0a06;
            --text: #333;
            --text-light: #777;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        

        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text);
            background-color: #f0f0f0;
            margin: 0;
            padding-top: 60px;
            overflow-x: hidden;
            font-weight: 400;
        }

        /* Prevent background scroll when modal is open */
        body.modal-open {
            overflow: hidden;
        }
        
        /* Button Styles */
        .btn-hamburger-menu {
            position: fixed;
            top: 15px;
            right: 20px;
            padding: 10px;
            border-radius: 5px;
            cursor: none;
            background: transparent;
            border: none;
            z-index: 1001;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .btn-hamburger-menu:active {
            color: var(--secondary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Hamburger Menu Styles */
        .dropdown-menu {
            position: fixed;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            display: none;
            min-width: 150px;
            overflow: hidden;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: none;
            color: var(--text);
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:active {
            background: var(--secondary);
            color: var(--light);
        }

        .dropdown-item.active {
            background: var(--secondary);
            color: var(--light);
        }

        /* Overlay to close dropdown when clicking outside */
        .dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 1000;
            display: none;
        }

        /* Update existing styles for better spacing */
        .names-form-section {
            padding: 80px 20px;
        }

        /* PAGE TOGGLE SECTION - UPDATED FOR SWIPE */
        .page-toggle-section {
            position: fixed !important;
            top: 15px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 1001 !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            margin: 0 !important;
            pointer-events: none !important;
        }

        /* Hide the toggle icons */
        .page-toggle-section .toggle-icon {
            display: none !important;
        }

        .page-toggle-section .toggle-label {
            font-weight: 600 !important;
            color: var(--text) !important;
            font-size: 14px !important;
            margin: 0 !important;
            font-family: 'Poppins', sans-serif !important;
            text-align: center !important;
        }

        /* KERTAS A4 BENAR-BENAR SEPERTI KERTAS CETAK */
        /* Margin dalam (kiri-kanan-atas-bawah) SELALU 20mm di semua orientasi & ukuran layar */
        #print-paper {
            width: 210mm;           /* lebar A4 */
            height: 297mm;          /* tinggi A4 */
            padding: 20mm;          /* INI YANG KAMU MAU: 20mm dari 4 sisi */
            box-sizing: border-box;
            background: white;
            margin: 20px auto;      /* jarak luar dari layar ke kertas */
            box-shadow: 0 4px 25px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            
            /* Make paper swipeable */
            touch-action: pan-y;
            user-select: none;
            
            /* Tetap pakai ukuran mm supaya 100% akurat saat print & di semua device */
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Hapus semua padding/margin lain yang mengganggu */
        #print-paper > * {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            padding: 10px;
            border-bottom: 1px solid #fff;
            position: relative;
            z-index: 0;
        }

        /* LOGO: jarak kiri-kanan-atas-bawah SAMA PERSIS dengan isi lain */
        .logo-wrapper {
            width: 100%;
            text-align: center;
            margin: 0 !important;
            padding: 0 !important;
        }

        .logo-img {
            max-width: 100%;                   /* biar tidak nyentuh tepi */
            height: auto;
            display: block;
            margin: 0 auto;
            margin-top: -100px;
        }

        h4 {
            font-size: 14px;
            margin: 5px 0px;
            font-family: 'Times New Roman', Times, serif;
        }

        p {
            font-size: 14px;
            margin: 5px 0;
        }

        table {
            width: 97%;
            border-collapse: collapse;
            margin: 0 auto;
        }

        th, td {
            border: 1px solid #000;
            font-family: 'Times New Roman', Times, serif;
        }

        th {
            background-color: #fff;
            text-align: center;
            padding: 5px 3px 6px;
            font-size: 14px;
        }

        td {
            text-align: left;
            padding: 2px 5px 5px;
            vertical-align: center;
            font-size: 14px;
        }

        .date {
            font-size: 12px;
        }

        .signature-wrapper {
            width: 100%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #fff;
            border: none;
            padding: 5px;
            box-sizing: border-box;
            margin-bottom: -5px;
        }

        .signature img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            object-position: center;
        }

        td:nth-child(1) { background-color: #fff; text-align: center; width: 7%; font-size: 14px; }
        td:nth-child(2) { background-color: #fff; width: 32%; font-size: 14px; }
        td:nth-child(3) { background-color: #fff; width: 15%; font-size: 14px; }
        td:nth-child(4) { background-color: #fff; width: 15%; font-size: 14px; }
        td:nth-child(5) { background-color: #fff; width: 17%; font-size: 14px; }

        .information p {
            text-align: left;
            margin-left: 1.5%;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
        }

        .informations p {
            text-align: left;
            margin-left: 1.5%;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
        }

        .informations {
            margin-top: -55px;
        }

        .keterangan {
            width: 60px;
            height: 25px;
            margin-top: -1.5px;
            font-size: 14px;
            border: none;
            background-color: transparent;
            cursor: none;
            appearance: none;
        }

        .keterangan:focus { outline: none; }

        .signature-section {
            position: relative;
            width: 97%;
            max-width: 97%;
            margin: 30px auto 10px auto;
            height: 20px;
        }

        .signature-section::before {
            content: '';
            position: absolute;
            top: -30.5px;
            left: 1px;
            right: 1px;
            height: 1px;
            background: black;
            transform: translateY(-50%);
        }

        .btn-delete,
        .btn-cancel {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: none;
            transition: all 0.2s ease;
            font-family: 'Times New Roman', Times, serif;
        }
        
        .btn-delete {
            background-color: white;
            color: red;
        }
        
        .btn-delete:active {
            background-color: red;
            color: white;
        }
        
        .btn-cancel {
            background-color: white;
            color: black;
        }
        
        .btn-cancel:active {
            background-color: black;
            color: white;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .btn-hamburger-menu {
                top: 15px;
                right: 15px;
                padding: 8px;
            }
            
            .dropdown-menu {
                top: 55px;
                right: 15px;
            }

            .page-toggle-section {
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                padding: 6px 12px;
            }
            
            .page-toggle-section .toggle-label {
                font-size: 12px;
            }
            
            .container {
                margin-top: 15px;
                width: 100%;
                height: auto;
                padding: 10mm;
            }
            
            .btn-delete,
            .btn-cancel {
                width: 100%;
            }
        }

        @media print {
            body, .container {
                margin: 0 !important;
                padding: 0 !important;
            }
            .container {
                width: 210mm !important;
                height: 297mm !important;
                padding: 20mm;
            }
            .btn-clear-signatures, nav, .page-toggle-section, .btn-hamburger-menu {
                display: none !important;
            }
        }

        /* Signature number and keterangan container */
        .signature-number {
            font-size: 14px;
            text-align: left;
            margin-bottom: 5px;
        }

        .keterangan-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .keterangan-number {
            font-size: 14px;
        }

.name-input {
    width: 100%;
    border: none;
    background: transparent;
    font-family: 'Times New Roman', Times, serif;
    font-size: 14px;
    padding: 2px 5px;
    outline: none;
    cursor: none;
}
.info-input {
    border: none;
    background: transparent;
    font-family: 'Times New Roman', Times, serif;
    font-size: 14px;
    padding: 2px 5px;
    outline: none;
    cursor: none;
    width: 80%;
    margin-left: 5px;
}

.info-input::placeholder {
    color: #999;
}

/* For PDF download - convert to text */
@media print {
    .info-input {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
        min-width: 0 !important;
    }
}

.title-input {
    width: 100%;
    border: none;
    background: transparent;
    font-family: 'Times New Roman', Times, serif;
    font-size: 14px;
    padding: 0;
    margin: 5px 0;
    outline: none;
    cursor: none;
    text-align: center;
    font-weight: normal;
}

.title-input::placeholder {
    color: #999;
}

/* Style for h4 elements containing title inputs */
.header h4 {
    margin: 5px 0;
    text-align: center;
}

/* For PDF download - convert to text */
@media print {
    .title-input {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
    }
}

/* Remove the old title styling if it exists */
#report-title1,
#report-title2,
#report-title3 {
    all: unset;
    display: block;
    width: 100%;
}
.date-input {
    border: none;
    background: transparent;
    font-family: 'Times New Roman', Times, serif;
    font-size: 12px;
    padding: 2px;
    outline: none;
    cursor: none;
    text-align: center;
    width: 100%;
    display: block;
}

.date-input::placeholder {
    color: #999;
}

/* Style for the date cell in table header */
th .date-input {
    font-weight: bold;
}

/* For PDF download - convert to text */
@media print {
    .date-input {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
    }
}

/* Login Modal Styles */
.login-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.login-modal {
    background: white;
    border-radius: 10px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
    animation: modalPop 0.3s ease;
}

.login-modal-content h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--text);
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    text-align: center;
}

.login-modal-content .firebase-login-subtitle {
    text-align: center;
    color: var(--text-light);
    margin-bottom: 25px;
    font-size: 14px;
}

.login-input-group {
    margin-bottom: 20px;
}

.login-input {
    width: 100%;
    padding: 12px 15px;
    border-radius: 6px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.login-input:focus {
    outline: none;
}

.login-password-container {
    position: relative;
}

.show-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: none;
    color: #666;
    padding: 5px;
}

.login-error {
    color: red;
    font-size: 13px;
    margin: 10px 0;
    padding: 8px 12px;
    background: #fff5f5;
    border-radius: 4px;
    display: none;
}

.login-button-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.login-btn, .register-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    cursor: none;
    transition: all 0.3s ease;
}

.login-btn {
    background: var(--secondary);
    color: white;
}

.login-btn:active {
    background: var(--secondary);
}

.register-btn {
    background: #f0f0f0;
    color: var(--text);
}

.register-btn:active {
    background: #e0e0e0;
}

.continue-offline {
    text-align: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.continue-btn {
    background: transparent;
    border: 1px solid #ddd;
    color: var(--text-light);
    padding: 10px 20px;
    border-radius: 6px;
    cursor: none;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
}

.continue-btn:active {
    background: #f5f5f5;
    border-color: #ccc;
}

.login-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: none;
    color: #666;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Login status indicator in dropdown */
.dropdown-item.login-button.logged-in {
    background: var(--secondary);
    color: white;
}

.login-user-info {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 3px;
}

/* Style for login button in dropdown */
.login-button .material-symbols-outlined {
    vertical-align: middle;
    margin-right: 8px;
}

/* Make login button positioned at bottom */
.dropdown-item.login-button {
    margin-top: auto;
    background: white;
}

.dropdown-item.login-button:active {
    background: var(--secondary);
    color: white;
}

/* Disabled input styles when not logged in */
body:not(.user-logged-in) .title-input:not(:focus),
body:not(.user-logged-in) .info-input:not(:focus),
body:not(.user-logged-in) .name-input:not(:focus) {
    background-color: white;
    cursor: not-allowed;
    color: #999;
}

/* Enable signature even when not logged in */
.signature-wrapper {
    cursor: none !important;
}

.division-toggle-group {
    display: flex;
    align-items: center;
}

.division-select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 4px;
    background: white;
    font-family: 'Poppins', sans-serif;
    font-size: 13px;
    color: var(--text);
    cursor: none;
    outline: none;
}

/* Gender Selector Styles */
.gender-toggle-group {
    display: flex;
    align-items: center;
}

.gender-select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 4px;
    background: transparent;
    font-family: 'Poppins', sans-serif;
    font-size: 13px;
    color: var(--text);
    cursor: none;
    outline: none;
    transition: border-color 0.3s ease;
}

/* Division indicator with gender */
#division-indicator {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 6px;
    background: var(--secondary);
    color: white;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
}

#gender-indicator {
    display: inline-block;
    margin-left: 4px;
    padding: 2px 6px;
    background: var(--secondary);
    color: white;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
}

/* Add this to your existing CSS styles */
#fallback-download-btn:active {
    color: var(--secondary) !important;
}

</style>
</head>
<body>
    <nav class="navbar">
    </nav>
    
    <!-- Hamburger Menu Button -->
    <button id="hamburger-menu" class="btn-hamburger-menu">
        <span class="material-symbols-outlined">menu</span>
    </button>
    
<!-- Dropdown Menu -->
<div id="dropdown-menu" class="dropdown-menu">
    <div class="dropdown-item" data-value="one-page">One Page</div>
    <div class="dropdown-item" data-value="two-page">Two Pages</div>
    <div class="dropdown-item" data-value="three-page">Three Pages</div>
    <div class="dropdown-item" data-value="four-page">Four Pages</div>
    <div class="dropdown-item" data-value="five-page">Five Pages</div>
    
<!-- Division Selector -->
<div class="dropdown-section">
    <div class="dropdown-section-label">Division:</div>
    <div class="division-toggle-group">
        <select id="division-select" class="division-select">
            <option value="Khusus">Khusus</option>
            <option value="Sekum">Sekum</option>
            <option value="Bendum">Bendum</option>
            <option value="PSDM">PSDM</option>
            <option value="Syidak">Syidak</option>
            <option value="DKMA">DKMA</option>
            <option value="JWR">JWR</option>
        </select>
    </div>
</div>

<!-- Gender Selector (shown immediately) -->
<div class="dropdown-section" id="gender-section">
    <div class="dropdown-section-label">Gender:</div>
    <div class="gender-toggle-group">
        <select id="gender-select" class="gender-select">
            <option value="Ikhwan">Ikhwan</option>
            <option value="Akhwat">Akhwat</option>
        </select>
    </div>
</div>
    
    <!-- Login Button at bottom -->
    <div class="dropdown-item login-button" id="dropdown-login-button">
        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px; margin-right: 8px;">
            login
        </span>
        Login
    </div>
</div>

    <!-- Page Toggle Section - Now just shows page number -->
    <div class="page-toggle-section">
        <div class="toggle-container">
            <span class="toggle-label" id="reportToggleLabel"></span>
        </div>
    </div>
    
    <div id="print-paper">
        <div id="report-container">
<div class="header">
    <div class="logo-wrapper">
        <img src="logo.png" class="logo-img" alt="Organization Logo">
    </div>
    <h4>
        <input type="text" class="title-input" id="report-title1" placeholder="PRESENSI KEHADIRAN PESERTA">
    </h4>
    <h4>
        <input type="text" class="title-input" id="report-title2" placeholder="NAMA PROGRAM KERJA">
    </h4>
    <h4>
        <input type="text" class="title-input" id="report-title3" placeholder="MASA BAKTI TAHUN/TAHUN">
    </h4>
</div>
<div class="information">
    <p>Waktu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:
        <input type="text" class="info-input" id="waktu-input" placeholder="00.00‚Äì00.00">
    </p>
    <p>Tempat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:
        <input type="text" class="info-input" id="tempat-input" placeholder="ruang kelas 0 0">
    </p>
    <p>Keterangan&nbsp;&nbsp;&nbsp;:
        <input type="text" class="info-input" id="keterangan-input" placeholder="syura riksasi Nama Proker">
    </p>
</div>
            <table border="1">
                <thead>
                    <tr>
                        <th rowspan="2">NO.</th>
                        <th rowspan="2">NAMA</th>
                        <th colspan="3"><input type="text" class="date-input" id="report-date" placeholder="hari, 00 bulan tahun"></th>
                    </tr>
                    <tr>
                        <th colspan="2">TANDA TANGAN</th>
                        <th>KETERANGAN</th>
                    </tr>
                </thead>
                <tbody id="report-table-body">
                    <!-- Dynamically populated by JavaScript -->
                </tbody>
            </table>
            <div class="signature-section">
                <div class="end-line left"></div>
                <div class="end-line right"></div>
            </div>
            <div class="informations">
                <p>Keterangan :</p>
                <p>1. Izin: <b>I</b></p>
                <p>2. Sakit: <b>S</b></p>
                <p>3. Tanpa keterangan: <b>TK</b></p>
            </div>
        </div>
    </div>

 <script src="firebase-config.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="firebase-db.js"></script>
<script>// ========== GLOBAL UTILITY FUNCTIONS ==========

// Simple login function
async function simpleLogin(email, password) {
    // Define allowed users with specific emails and passwords
    const allowedUsers = {
        'ami.smaitnh.2.0@gmail.com': '<!AMI 2.0>',
        'mps.smaitnh.2.0@gmail.com': 'MPS2',
        'osis.smaitnh.2.0@gmail.com': 'OSIS',
        'da.smaitnh.2.0@gmail.com': 'DA2'
    };
    
    console.log('üîê Attempting simple login for:', email);
    
    // Check if email exists in allowed users
    if (allowedUsers[email]) {
        // Check if password matches
        if (password === allowedUsers[email]) {
            // Try Firebase login first if available
            if (window.firebaseAuth && window.firebaseAuth.isInitialized) {
                console.log('üîÑ Trying Firebase login...');
                const firebaseResult = await window.firebaseAuth.login(email, password);
                
                if (firebaseResult.success) {
                    console.log('‚úÖ Firebase login successful');
                    
                    localStorage.setItem('currentUser', JSON.stringify({
                        email: email,
                        displayName: email.split('@')[0].replace(/\./g, ' ').replace('advanced ', ''),
                        isLoggedIn: true,
                        role: email.split('.')[1].toUpperCase()
                    }));
                    
                    return {
                        success: true,
                        user: {
                            email: email,
                            displayName: email.split('@')[0].replace(/\./g, ' ').replace('advanced ', ''),
                            role: email.split('.')[1].toUpperCase()
                        }
                    };
                } else {
                    console.log('‚ö†Ô∏è Firebase login failed:', firebaseResult.error);
                    // Fall back to local login
                }
            }
            
            // Local login (fallback)
            localStorage.setItem('currentUser', JSON.stringify({
                email: email,
                displayName: email.split('@')[0].replace(/\./g, ' ').replace('advanced ', ''),
                isLoggedIn: true,
                role: email.split('.')[1].toUpperCase()
            }));
            
            console.log('‚úÖ Local login successful');
            
            return {
                success: true,
                user: {
                    email: email,
                    displayName: email.split('@')[0].replace(/\./g, ' ').replace('advanced ', ''),
                    role: email.split('.')[1].toUpperCase()
                }
            };
        } else {
            console.log('‚ùå Invalid password for:', email);
            return { success: false, error: 'Invalid password' };
        }
    }
    
    console.log('‚ùå Email not authorized:', email);
    return { success: false, error: 'Email not authorized' };
}

// Login Modal Functions
function showLoginModal() {
    console.log("üîê Showing login modal");
    
    // Check if modal already exists
    if (document.getElementById('login-modal')) {
        document.getElementById('login-modal').classList.add('show');
        document.body.classList.add('modal-open');
        return;
    }
    
    // Create modal HTML
    const modalHTML = `
        <div id="login-modal" class="login-modal-overlay">
            <div class="login-modal">
                <button class="login-close-btn">&times;</button>
                
                <div class="login-modal-content">
                    <h3>Login to Edit</h3>
                    <p class="firebase-login-subtitle">Login to edit titles, info, names, and keterangan</p>
                    
                    <div class="login-input-group">
                        <input type="email" id="login-email" 
                               class="login-input" 
                               placeholder="Email address"
                               autocomplete="email">
                    </div>
                    
                    <div class="login-input-group">
                        <div class="login-password-container">
                            <input type="password" id="login-password" 
                                   class="login-input" 
                                   placeholder="Password"
                                   autocomplete="current-password">
                            <button type="button" class="show-password" id="show-password">
                                <span class="material-symbols-outlined">visibility</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="login-error" class="login-error"></div>
                    
                    <div class="login-button-group">
                        <button id="modal-login-btn" class="login-btn">
                            Login
                        </button>
                        <button id="modal-register-btn" class="register-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                            Registration Disabled
                        </button>
                    </div>
                    
                    <div class="continue-offline">
                        <button id="modal-continue-btn" class="continue-btn">
                            Continue without login
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.body.classList.add('modal-open');
    
    // Get references
    const modal = document.getElementById('login-modal');
    const emailInput = document.getElementById('login-email');
    const passwordInput = document.getElementById('login-password');
    const showPasswordBtn = document.getElementById('show-password');
    const errorDiv = document.getElementById('login-error');
    
    // Show modal with animation
    setTimeout(() => {
        modal.classList.add('show');
        
        // Focus on email input
        setTimeout(() => {
            emailInput.focus();
        }, 300);
    }, 10);
    
    // Toggle password visibility
    showPasswordBtn.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // Change icon
        const icon = showPasswordBtn.querySelector('.material-symbols-outlined');
        icon.textContent = type === 'password' ? 'visibility' : 'visibility_off';
    });
    
    // Login button
    document.getElementById('modal-login-btn').addEventListener('click', async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        
        // Clear previous errors
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
        
        // Validation
        if (!email) {
            errorDiv.textContent = 'Please enter your email';
            errorDiv.style.display = 'block';
            emailInput.focus();
            return;
        }
        
        if (!password) {
            errorDiv.textContent = 'Please enter your password';
            errorDiv.style.display = 'block';
            passwordInput.focus();
            return;
        }
        
        // Show loading state
        const loginBtn = document.getElementById('modal-login-btn');
        const originalText = loginBtn.textContent;
        loginBtn.textContent = 'Logging in...';
        loginBtn.disabled = true;
        
        try {
            // Use Firebase auth if available, otherwise use simple auth
            let result;
            if (window.firebaseAuth) {
                result = await window.firebaseAuth.login(email, password);
            } else {
                // Simple local auth for demo
                result = await simpleLogin(email, password);
            }
            
            if (result.success) {
                // Success - close modal and update UI
                closeLoginModal();
                updateLoginUI(true, result.user || { email: email });
                showNotification('Login successful! ‚úÖ', 'success');
            } else {
                // Show error
                errorDiv.textContent = result.error;
                errorDiv.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        } catch (error) {
            errorDiv.textContent = 'An unexpected error occurred';
            errorDiv.style.display = 'block';
        } finally {
            // Restore button
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;
        }
    });
    
    // Register button - show message that registration is disabled
    document.getElementById('modal-register-btn').addEventListener('click', async () => {
        errorDiv.textContent = 'Registration disabled. Only authorized users can login.';
        errorDiv.style.display = 'block';
        errorDiv.style.color = '#e74c3c';
    });
    
    // Continue without login
    document.getElementById('modal-continue-btn').addEventListener('click', () => {
        closeLoginModal();
        showNotification('Continuing in read-only mode üì±', 'info');
    });
    
    // Close button
    modal.querySelector('.login-close-btn').addEventListener('click', () => {
        closeLoginModal();
    });
    
    // Close on outside click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeLoginModal();
        }
    });
    
    // Close on Escape key
    const handleEscape = (e) => {
        if (e.key === 'Escape' && modal.classList.contains('show')) {
            closeLoginModal();
        }
    };
    document.addEventListener('keydown', handleEscape);
    
    // Enter key to submit
    const handleEnterKey = (e) => {
        if (e.key === 'Enter' && modal.classList.contains('show')) {
            if (emailInput === document.activeElement || passwordInput === document.activeElement) {
                document.getElementById('modal-login-btn').click();
            }
        }
    };
    document.addEventListener('keydown', handleEnterKey);
    
    // Cleanup function
    modal.cleanup = () => {
        document.removeEventListener('keydown', handleEscape);
        document.removeEventListener('keydown', handleEnterKey);
    };
}

function closeLoginModal() {
    const modal = document.getElementById('login-modal');
    if (modal) {
        // Run cleanup if exists
        if (modal.cleanup) {
            modal.cleanup();
        }
        
        // Remove with animation
        modal.classList.remove('show');
        setTimeout(() => {
            if (modal.parentNode) {
                modal.remove();
                document.body.classList.remove('modal-open');
            }
        }, 300);
    }
}

// Notification function
function showNotification(message, type = 'info') {
    document.querySelectorAll('.signature-notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `signature-notification ${type}`;
    notification.innerHTML = message;
    
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        background: ${type === 'success' ? '#6bcf7f' : type === 'error' ? '#ff6b6b' : '#2196F3'};
        color: white;
        z-index: 10001;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
        animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Download functions
function simpleDownload() {
    console.log('Using simple download method...');
    
    // Clone the paper element to preserve original state
    const originalPaper = document.getElementById('print-paper');
    const clonedPaper = originalPaper.cloneNode(true);
    
    // Temporarily replace all input elements with their values as text
    replaceInputsWithText(clonedPaper);
    
    // Create temporary container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = `
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 210mm;
        height: 297mm;
        padding: 20mm;
        background: white;
        z-index: -1;
    `;
    
    tempContainer.appendChild(clonedPaper);
    document.body.appendChild(tempContainer);
    
    // Hide UI elements temporarily
    const uiElements = document.querySelectorAll('#hamburger-menu, #download-paper, .page-toggle-section, .btn-hamburger-menu, .btn-download-paper, #fallback-download-btn');
    uiElements.forEach(el => el.style.visibility = 'hidden');
    
    // Take screenshot
    html2canvas(clonedPaper, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true,
        logging: false,
        allowTaint: true
    }).then(canvas => {
        // Restore UI elements
        uiElements.forEach(el => el.style.visibility = 'visible');
        
        // Clean up temporary container
        document.body.removeChild(tempContainer);
        
        // Download as PNG
        const link = document.createElement('a');
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        const dateStr = new Date().toISOString().slice(0, 10);
        link.download = `Presensi_${currentDivision}_${currentGender}_${dateStr}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showNotification('‚úÖ Downloaded as PNG image', 'success');
    }).catch(error => {
        console.error('Simple download failed:', error);
        showNotification('‚ùå Download failed. Please try again.', 'error');
        
        // Clean up on error
        uiElements.forEach(el => el.style.visibility = 'visible');
        if (tempContainer.parentNode) {
            document.body.removeChild(tempContainer);
        }
    });
}

// Helper function to replace inputs with text
function replaceInputsWithText(element) {
    // First get all current values from the ORIGINAL document
    const originalValues = {
        title1: document.getElementById('report-title1')?.value || '',
        title2: document.getElementById('report-title2')?.value || '',
        title3: document.getElementById('report-title3')?.value || '',
        waktu: document.getElementById('waktu-input')?.value || '',
        tempat: document.getElementById('tempat-input')?.value || '',
        keteranganInfo: document.getElementById('keterangan-input')?.value || '',
        date: document.querySelector('.date-input')?.value || ''
    };
    
    // Get all original name values
    const originalNameInputs = document.querySelectorAll('.name-input');
    const originalNames = {};
    originalNameInputs.forEach(input => {
        originalNames[input.dataset.index] = {
            value: input.value || '',
            hasContent: input.value.trim() !== ''
        };
    });
    
    // Get all original keterangan values
    const originalKeteranganSelects = document.querySelectorAll('.keterangan');
    const originalKeterangan = {};
    originalKeteranganSelects.forEach(select => {
        const index = select.dataset.index;
        const value = select.value || '';
        const name = select.dataset.name || '';
        originalKeterangan[index] = {
            value: value,
            name: name,
            hasValue: value.trim() !== ''
        };
    });
    
    // Get original signature data
    const originalSignatures = {};
    document.querySelectorAll('.signature').forEach(sig => {
        const index = sig.dataset.index;
        if (sig.innerHTML.trim() !== '') {
            originalSignatures[index] = sig.innerHTML;
        }
    });
    
    // Replace title inputs with actual values
    const titleInputs = element.querySelectorAll('.title-input');
    titleInputs.forEach((input, index) => {
        const span = document.createElement('span');
        let value = '';
        if (index === 0) value = originalValues.title1;
        else if (index === 1) value = originalValues.title2;
        else if (index === 2) value = originalValues.title3;
        
        span.textContent = value;
        span.style.cssText = `
            display: inline-block;
            width: 100%;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            text-align: center;
            margin: 5px 0;
            min-height: 1.2em;
        `;
        input.parentNode.replaceChild(span, input);
    });
    
    // Replace info inputs with actual values
    const infoInputs = element.querySelectorAll('.info-input');
    infoInputs.forEach((input, index) => {
        const span = document.createElement('span');
        let value = '';
        if (input.id === 'waktu-input') value = originalValues.waktu;
        else if (input.id === 'tempat-input') value = originalValues.tempat;
        else if (input.id === 'keterangan-input') value = originalValues.keteranganInfo;
        
        span.textContent = value;
        span.style.cssText = `
            display: inline-block;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            margin-left: 5px;
            min-height: 1.2em;
        `;
        input.parentNode.replaceChild(span, input);
    });
    
    // Replace date input with actual value
    const dateInput = element.querySelector('.date-input');
    if (dateInput) {
        const span = document.createElement('span');
        span.textContent = originalValues.date;
        span.style.cssText = `
            display: block;
            font-family: 'Times New Roman', Times, serif;
            font-size: 12px;
            text-align: center;
            width: 100%;
            min-height: 1.2em;
        `;
        dateInput.parentNode.replaceChild(span, dateInput);
    }
    
    // Preserve the original table structure
    preserveTableStructure(element);
    
    // Process table rows - Show pairs only if at least one has name
    processTablePairs(element, originalNames, originalKeterangan, originalSignatures);
    
    // Ensure signature numbers are visible
    ensureSignatureNumbersVisible(element);
}

function preserveTableStructure(element) {
    const table = element.querySelector('table');
    if (!table) return;
    
    // Ensure proper column structure
    const thead = table.querySelector('thead');
    if (thead) {
        const headerRows = thead.querySelectorAll('tr');
        if (headerRows.length >= 2) {
            // Keep original structure but update date
            const dateCell = headerRows[0].querySelector('th[colspan="3"]');
            if (dateCell) {
                const dateSpan = document.createElement('span');
                const originalDate = document.querySelector('.date-input')?.value || '';
                dateSpan.textContent = originalDate;
                dateSpan.style.cssText = `
                    font-family: 'Times New Roman', Times, serif;
                    font-size: 12px;
                    text-align: center;
                    display: block;
                    width: 100%;
                `;
                dateCell.innerHTML = '';
                dateCell.appendChild(dateSpan);
            }
        }
    }
}

function processTablePairs(element, originalNames, originalKeterangan, originalSignatures) {
    const allRows = Array.from(element.querySelectorAll('#report-table-body tr'));
    const rowPairs = [];
    
    // Group rows into pairs
    for (let i = 0; i < allRows.length; i += 2) {
        if (allRows[i] && allRows[i + 1]) {
            rowPairs.push([allRows[i], allRows[i + 1]]);
        }
    }
    
    // First, hide ALL rows initially
    allRows.forEach(row => {
        row.style.display = 'none';
    });
    
    // Track visible pairs
    let visiblePairCount = 0;
    
    // Show only pairs that have at least one name
    rowPairs.forEach((pair, pairIndex) => {
        const [row1, row2] = pair;
        
        // Check indices for this pair
        const index1 = pairIndex * 2;
        const index2 = (pairIndex * 2) + 1;
        
        // Check if this pair has any content
        const hasName1 = originalNames[index1] && originalNames[index1].hasContent;
        const hasName2 = originalNames[index2] && originalNames[index2].hasContent;
        const hasAnyContent = hasName1 || hasName2;
        
        // If this pair has at least one name, show the entire pair
        if (hasAnyContent) {
            // Show both rows of the pair
            row1.style.display = '';
            row2.style.display = '';
            
            // Fix the row structure with original data
            fixRowStructure(row1, row2, pairIndex + 1, originalNames, originalKeterangan, originalSignatures);
            
            visiblePairCount++;
        }
    });
    
    // If NO pairs have any names, show just the first pair as empty
    if (visiblePairCount === 0 && rowPairs.length > 0) {
        const firstPair = rowPairs[0];
        const [row1, row2] = firstPair;
        
        row1.style.display = '';
        row2.style.display = '';
        
        // Fix the row structure for the first pair
        fixRowStructure(row1, row2, 1, originalNames, originalKeterangan, originalSignatures);
    }
}

function fixRowStructure(row1, row2, pairNumber, originalNames, originalKeterangan, originalSignatures) {
    // Get the row numbers
    const rowNumber1 = (pairNumber * 2) - 1;
    const rowNumber2 = pairNumber * 2;
    
    // Get the original indices
    const index1 = (pairNumber - 1) * 2;
    const index2 = ((pairNumber - 1) * 2) + 1;
    
    // Get original values
    const originalName1 = originalNames[index1];
    const originalName2 = originalNames[index2];
    const originalKeterangan1 = originalKeterangan[index1];
    const originalKeterangan2 = originalKeterangan[index2];
    const originalSignature1 = originalSignatures[index1];
    const originalSignature2 = originalSignatures[index2];
    
    // Determine if we should show keterangan
    const showKeterangan1 = originalName1?.hasContent && originalKeterangan1?.hasValue;
    const showKeterangan2 = originalName2?.hasContent && originalKeterangan2?.hasValue;
    
    // Rebuild row1 (first row of the pair)
    row1.innerHTML = `
        <td style="text-align: center; background-color: #fff; width: 7%; font-size: 14px; border: 1px solid #000;">${rowNumber1}.</td>
        <td style="background-color: #fff; width: 32%; font-size: 14px; border: 1px solid #000;">
            <span class="name-span" style="display: inline-block; width: 100%; font-family: 'Times New Roman', Times, serif; font-size: 14px; padding: 2px 5px;">
                ${originalName1?.value || ''}
            </span>
        </td>
        <td rowspan="2" style="background-color: #fff; width: 15%; font-size: 14px; border: 1px solid #000;">
            <div class="signature-number" style="font-size: 14px; text-align: left; margin-bottom: 5px;">${rowNumber1}.</div>
            <div class="signature-wrapper" style="width: 100%; height: 50px; display: flex; align-items: center; justify-content: center; background-color: #fff; border: none; padding: 5px; box-sizing: border-box; margin-bottom: -5px;">
                <div class="signature" data-index="${index1}" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    ${originalSignature1 || ''}
                </div>
            </div>
        </td>
        <td rowspan="2" style="background-color: #fff; width: 15%; font-size: 14px; border: 1px solid #000;">
            <div class="signature-number" style="font-size: 14px; text-align: left; margin-bottom: 5px;">${rowNumber2}.</div>
            <div class="signature-wrapper" style="width: 100%; height: 50px; display: flex; align-items: center; justify-content: center; background-color: #fff; border: none; padding: 5px; box-sizing: border-box; margin-bottom: -5px;">
                <div class="signature" data-index="${index2}" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    ${originalSignature2 || ''}
                </div>
            </div>
        </td>
        <td style="background-color: #fff; width: 17%; font-size: 14px; border: 1px solid #000;">
            <div class="keterangan-container" style="display: flex; align-items: center; gap: 5px;">
                <span class="keterangan-number" style="font-size: 14px;">${rowNumber1}.</span>
                ${showKeterangan1 ? 
                    `<span style="font-family: 'Times New Roman', Times, serif; font-size: 14px;">${originalKeterangan1?.value || ''}</span>` : 
                    `<span style="font-family: 'Times New Roman', Times, serif; font-size: 14px;"> </span>`
                }
            </div>
        </td>
    `;
    
    // Rebuild row2 (second row of the pair)
    row2.innerHTML = `
        <td style="text-align: center; background-color: #fff; width: 7%; font-size: 14px; border: 1px solid #000;">${rowNumber2}.</td>
        <td style="background-color: #fff; width: 32%; font-size: 14px; border: 1px solid #000;">
            <span class="name-span" style="display: inline-block; width: 100%; font-family: 'Times New Roman', Times, serif; font-size: 14px; padding: 2px 5px;">
                ${originalName2?.value || ''}
            </span>
        </td>
        <td style="background-color: #fff; width: 17%; font-size: 14px; border: 1px solid #000;">
            <div class="keterangan-container" style="display: flex; align-items: center; gap: 5px;">
                <span class="keterangan-number" style="font-size: 14px;">${rowNumber2}.</span>
                ${showKeterangan2 ? 
                    `<span style="font-family: 'Times New Roman', Times, serif; font-size: 14px;">${originalKeterangan2?.value || ''}</span>` : 
                    `<span style="font-family: 'Times New Roman', Times, serif; font-size: 14px;"> </span>`
                }
            </div>
        </td>
    `;
    
    // Make empty names invisible
    const nameSpan1 = row1.querySelector('.name-span');
    const nameSpan2 = row2.querySelector('.name-span');
    
    if (nameSpan1 && (!originalName1?.hasContent || originalName1.value.trim() === '')) {
        nameSpan1.textContent = '';
        nameSpan1.style.color = 'transparent';
    }
    
    if (nameSpan2 && (!originalName2?.hasContent || originalName2.value.trim() === '')) {
        nameSpan2.textContent = '';
        nameSpan2.style.color = 'transparent';
    }
}

function ensureSignatureNumbersVisible(element) {
    const allSignatureNumbers = element.querySelectorAll('.signature-number');
    allSignatureNumbers.forEach(span => {
        span.style.display = '';
        span.style.visibility = 'visible';
        span.style.opacity = '1';
        span.style.color = '#000000';
        span.style.fontSize = '14px';
        span.style.fontFamily = "'Times New Roman', Times, serif";
    });
    
    // Also ensure keterangan numbers are visible
    const allKeteranganNumbers = element.querySelectorAll('.keterangan-number');
    allKeteranganNumbers.forEach(span => {
        span.style.display = '';
        span.style.visibility = 'visible';
        span.style.opacity = '1';
        span.style.color = '#000000';
        span.style.fontSize = '14px';
        span.style.fontFamily = "'Times New Roman', Times, serif";
    });
}

function addFallbackDownloadButton() {
    // Check if button already exists
    if (document.getElementById('fallback-download-btn')) return;
    
    const fallbackBtn = document.createElement('button');
    fallbackBtn.id = 'fallback-download-btn';
    fallbackBtn.innerHTML = '<span class="material-symbols-outlined">download</span>';
    fallbackBtn.title = 'Download as Image';
    fallbackBtn.style.cssText = `
        position: fixed;
        top: 18.5px;
        right: 80px;
        z-index: 1001;
        background: transparent;
        border: none;
        color: var(--text);
        cursor: none;
        padding: 6px;
        border-radius: 5px;
        transition: all 0.3s ease;
    `;
    
    fallbackBtn.onclick = simpleDownload;
    
    // Remove or modify hover effect
    fallbackBtn.onmouseover = () => {
        fallbackBtn.style.color = 'var(--text)';
    };
    
    fallbackBtn.onmouseout = () => {
        fallbackBtn.style.color = 'var(--text)';
        fallbackBtn.style.backgroundColor = 'transparent';
    };
    
    // Also prevent green color on click/active state
    fallbackBtn.onmousedown = () => {
        fallbackBtn.style.color = 'var(--text)';
    };
    
    fallbackBtn.onmouseup = () => {
        fallbackBtn.style.color = 'var(--text)';
    };
    
    document.body.appendChild(fallbackBtn);
}

// ========== MAIN APPLICATION CODE ==========
document.addEventListener('DOMContentLoaded', () => {
    console.log('report.js: DOM loaded');
    
    const defaultTitles = ["", "", ""];
    let currentPage = localStorage.getItem('currentPage') || '1';
    let displayMode = localStorage.getItem('displayMode') || 'one-page';
    let currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
    let currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
    let rowHeaderNames = [];
    
    // Page toggle elements
    const toggleLabel = document.getElementById('reportToggleLabel');
    const toggleSection = document.querySelector('.page-toggle-section');
    const hamburgerMenu = document.getElementById('hamburger-menu');
    const dropdownMenu = document.getElementById('dropdown-menu');
    
    // ========== SWIPE GESTURE VARIABLES ==========
    let touchStartX = 0;
    let touchEndX = 0;
    let isSwiping = false;
    let swipeStartTime = 0;

    // ========== KEY MANAGEMENT FUNCTIONS ==========
    function getFullDivisionKey(key) {
        return `${currentDivision}_${currentGender}_${key}`;
    }

    function loadAttendanceNames() {
        const divisionKey = getFullDivisionKey('attendanceNames');
        const saved = localStorage.getItem(divisionKey);
        rowHeaderNames = saved ? JSON.parse(saved) : [];
        console.log(`Loaded names for ${currentDivision}_${currentGender}:`, rowHeaderNames.length, 'names');
        return rowHeaderNames;
    }
    
    function cleanupTrailingEmptyPairs() {
        for (let i = rowHeaderNames.length - 1; i >= 0; i -= 2) {
            const name1 = rowHeaderNames[i - 1] || '';
            const name2 = rowHeaderNames[i] || '';
            
            if (name1.trim() === '' && name2.trim() === '') {
                rowHeaderNames.pop();
                rowHeaderNames.pop();
                console.log('Removed trailing empty pair');
            } else {
                break;
            }
        }
        
        saveAttendanceNames();
    }
    
    function saveNameAtIndex(index, name) {
    loadAttendanceNames();
    
    // Get the old name before updating
    const oldName = rowHeaderNames[index] || '';
    
    // Ensure array is large enough
    while (rowHeaderNames.length <= index) {
        rowHeaderNames.push('');
    }
    
    // Update the name
    rowHeaderNames[index] = name;
    
    console.log(`üíæ Saving name at index ${index}: "${oldName}" -> "${name}"`);
    
    // Save to localStorage
    const divisionKey = getFullDivisionKey('attendanceNames');
    localStorage.setItem(divisionKey, JSON.stringify(rowHeaderNames));
    
    // Clean up trailing empty pairs
    cleanupTrailingEmptyPairs();
    
    console.log(`‚úÖ Saved name for ${currentDivision}_${currentGender}:`, {
        index,
        name,
        totalNames: rowHeaderNames.length,
        allNames: rowHeaderNames
    });
    
    // Force UI update IMMEDIATELY
    forceUpdateTableRows();
    
    // Update signature and keterangan for this index
    updateSignatureAndKeteranganForIndex(index, name);
    
    // Trigger sync events
    window.dispatchEvent(new CustomEvent('namesUpdate'));
    
    // If name changed (not just cleared), handle Firebase update
    if (name && name.trim() !== '' && oldName !== name) {
        updateNameInFirebase(oldName, name);
    } else if ((!name || name.trim() === '') && oldName && oldName.trim() !== '') {
        // Name was cleared, delete from Firebase
        console.log(`üóëÔ∏è Name cleared at index ${index}, deleting "${oldName}" from Firebase`);
        
        if (window.dbManager && window.dbManager.isInitialized) {
            window.dbManager.deleteFromFirebase(oldName, currentDivision, currentGender)
                .then(result => {
                    console.log(`Firebase deletion result for "${oldName}":`, result);
                })
                .catch(error => {
                    console.error(`Error deleting "${oldName}" from Firebase:`, error);
                });
        }
    }
}

function deleteNameAtIndex(index) {
    loadAttendanceNames();
    
    if (index >= 0 && index < rowHeaderNames.length) {
        const nameToDelete = rowHeaderNames[index];
        
        // Delete from localStorage
        rowHeaderNames[index] = '';
        cleanupTrailingEmptyPairs();
        saveAttendanceNames();
        
        // Delete from spreadsheet data
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        const spreadsheetKey = `${currentDivision}_${currentGender}_spreadsheetData`;
        const spreadsheetData = JSON.parse(localStorage.getItem(spreadsheetKey) || '{}');
        
        let deletedFromLocalStorage = false;
        if (spreadsheetData[nameToDelete]) {
            delete spreadsheetData[nameToDelete];
            localStorage.setItem(spreadsheetKey, JSON.stringify(spreadsheetData));
            deletedFromLocalStorage = true;
            console.log(`üóëÔ∏è Deleted "${nameToDelete}" from localStorage spreadsheet`);
        }
        
        // Delete from Firebase /attendance_data collection
        if (nameToDelete && nameToDelete.trim() !== '') {
            deleteNameFromFirebaseAttendanceData(nameToDelete, currentDivision, currentGender)
                .then(result => {
                    if (result.success || result.deletedCount > 0) {
                        showNotification(`‚úÖ "${nameToDelete}" deleted from table and Firebase (${result.deletedCount || 0} documents)`, 'success');
                        console.log(`‚úÖ Firebase deletion successful for "${nameToDelete}"`);
                    } else {
                        showNotification(`‚ö†Ô∏è "${nameToDelete}" deleted from table only (Firebase failed)`, 'warning');
                        console.warn(`‚ö†Ô∏è Firebase deletion failed for "${nameToDelete}":`, result.error);
                    }
                })
                .catch(error => {
                    console.error(`‚ùå Error deleting "${nameToDelete}" from Firebase:`, error);
                    showNotification(`‚ùå "${nameToDelete}" deleted from table only`, 'warning');
                });
        } else {
            showNotification('Empty name cleared from table', 'info');
        }
        
        // Regenerate table
        generateTableRows();
        
        // Dispatch update event
        window.dispatchEvent(new CustomEvent('namesUpdate'));
    }
}

function updateNameInFirebase(oldName, newName) {
    if (!oldName || !newName || oldName === newName) return;
    
    const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
    const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
    const key = `${currentDivision}_${currentGender}_spreadsheetData`;
    
    if (window.dbManager && window.dbManager.isInitialized) {
        // Get the old data
        const localData = JSON.parse(localStorage.getItem(key) || '{}');
        const oldData = localData[oldName];
        
        if (oldData) {
            // Copy data to new name
            localData[newName] = oldData;
            delete localData[oldName];
            localStorage.setItem(key, JSON.stringify(localData));
            
            console.log(`Updated name in localStorage: "${oldName}" ‚Üí "${newName}"`);
            
            // Update in Firebase
            const signatureDataUrl = oldData.image || '';
            const keterangan = oldData.keterangan || '';
            
            window.dbManager.saveSignature(newName, signatureDataUrl, keterangan)
                .then(result => {
                    console.log(`Updated name in Firebase: "${oldName}" ‚Üí "${newName}"`);
                    
                    // Delete old name from Firebase
                    window.dbManager.deleteFromFirebase(oldName, currentDivision, currentGender)
                        .then(deleteResult => {
                            console.log(`Deleted old name from Firebase: "${oldName}"`);
                        });
                });
        }
    }
}
    
    function loadAttendanceInfo() {
        const savedInfo = JSON.parse(localStorage.getItem(getFullDivisionKey('attendanceInfo')) || '{}');
        
        const waktuInput = document.getElementById('waktu-input');
        const tempatInput = document.getElementById('tempat-input');
        const keteranganInput = document.getElementById('keterangan-input');
        
        if (waktuInput) waktuInput.value = savedInfo.waktu || "";
        if (tempatInput) tempatInput.value = savedInfo.tempat || "";
        if (keteranganInput) keteranganInput.value = savedInfo.keterangan || "";
    }
    
    function loadTitles() {
        const savedTitles = JSON.parse(localStorage.getItem(getFullDivisionKey('reportTitles')) || '[]');
        const defaultTitles = ["", "", ""];
        
        const title1 = document.getElementById('report-title1');
        const title2 = document.getElementById('report-title2');
        const title3 = document.getElementById('report-title3');
        
        if (title1) title1.value = savedTitles[0] || defaultTitles[0];
        if (title2) title2.value = savedTitles[1] || defaultTitles[1];
        if (title3) title3.value = savedTitles[2] || defaultTitles[2];
    }
    
    function loadDivisionData() {
        console.log(`Loading data for division: ${currentDivision}_${currentGender}`);
        
        // Load attendance names
        loadAttendanceNames();
        
        // Load titles
        loadTitles();
        
        // Load attendance info
        loadAttendanceInfo();
        
        // Load date
        setDynamicDate();
        
        // Load signatures
        loadSignaturesAndKeterangan();
    }
    
    function saveDivisionData() {
        console.log(`Saving data for division: ${currentDivision}_${currentGender}`);
        
        // Save attendance names
        saveAttendanceNames();
        
        // Save titles
        saveReportTitles();
        
        // Save attendance info
        saveAttendanceInfo();
        
        // Save date
        const dateInput = document.querySelector('.date-input');
        if (dateInput) {
            localStorage.setItem(getFullDivisionKey('tanggalPresensi'), dateInput.value);
        }
    }

    // ========== MIGRATE OLD DATA ==========
    function migrateOldData() {
        console.log('Checking for old data migration...');
        
        // List of data keys to migrate
        const dataKeys = [
            'attendanceNames',
            'attendanceInfo', 
            'reportTitles',
            'tanggalPresensi',
            'spreadsheetData'
        ];
        
        // Get all divisions
        const divisions = ['Khusus', 'Sekum', 'Bendum', 'PSDM', 'Syidak', 'DKMA', 'JWR'];
        const genders = ['Ikhwan', 'Akhwat'];
        
        // For each division and gender
        divisions.forEach(division => {
            genders.forEach(gender => {
                dataKeys.forEach(key => {
                    // Check for old key (without gender)
                    const oldKey = `${division}_${key}`;
                    const newKey = `${division}_${gender}_${key}`;
                    
                    // If old data exists and new data doesn't exist yet
                    const oldData = localStorage.getItem(oldKey);
                    const newData = localStorage.getItem(newKey);
                    
                    if (oldData && !newData) {
                        // Migrate Ikhwan data from old format
                        if (gender === 'Ikhwan') {
                            localStorage.setItem(newKey, oldData);
                            console.log(`Migrated ${oldKey} to ${newKey}`);
                            
                            // For spreadsheetData, we need to keep the data for both genders
                            if (key === 'spreadsheetData') {
                                try {
                                    const parsedData = JSON.parse(oldData);
                                    localStorage.setItem(newKey, JSON.stringify(parsedData));
                                } catch (e) {
                                    console.error('Error migrating spreadsheetData:', e);
                                }
                            }
                        }
                    }
                });
            });
        });
    }

    // ========== MAIN VIEW FUNCTIONS ==========
    function updateActiveDropdownItem() {
        const items = ['one-page', 'two-page', 'three-page', 'four-page', 'five-page'];
        
        items.forEach(item => {
            const element = document.querySelector(`[data-value="${item}"]`);
            if (element) {
                element.classList.toggle('active', displayMode === item);
            }
        });
    }

    function updateReportView() {
        let totalPages = 1;
        switch(displayMode) {
            case 'one-page': totalPages = 1; break;
            case 'two-page': totalPages = 2; break;
            case 'three-page': totalPages = 3; break;
            case 'four-page': totalPages = 4; break;
            case 'five-page': totalPages = 5; break;
        }
        
        if (displayMode === 'one-page') {
            if (toggleSection) {
                toggleSection.style.display = 'flex';
                toggleLabel.textContent = `All Names - ${currentDivision} ${currentGender}`;
            }
            
            document.querySelectorAll('.swipe-hint').forEach(hint => hint.remove());
        } else {
            if (toggleSection) {
                toggleSection.style.display = 'flex';
                toggleLabel.textContent = `${currentDivision} ${currentGender} - Page ${currentPage} of ${totalPages}`;
            }
            
            showSwipeHints();
        }
        
        updateVisibility();
        generateTableRows();
        updateActiveDropdownItem();
    }

    function updateVisibility() {
        const header = document.querySelector('.header');
        const information = document.querySelector('.information');
        const informations = document.querySelector('.informations');
        
        if (displayMode === 'one-page') {
            header.style.display = 'block';
            information.style.display = 'block';
            informations.style.display = 'block';
            
            document.querySelectorAll('.header h4').forEach(h4 => {
                h4.style.display = 'block';
            });
        } else {
            if (currentPage === '1') {
                header.style.display = 'block';
                document.querySelectorAll('.header h4').forEach(h4 => {
                    h4.style.display = 'block';
                });
                information.style.display = 'block';
                informations.style.display = 'none';
            } else {
                header.style.display = 'block';
                document.querySelectorAll('.header h4').forEach(h4 => {
                    h4.style.display = 'none';
                });
                information.style.display = 'none';
                informations.style.display = 'block';
            }
        }
    }

    // ========== SWIPE GESTURE FUNCTIONS ==========
    function initializeSwipeGestures() {
        const paperElement = document.getElementById('print-paper');
        if (!paperElement) return;
        
        console.log('Initializing swipe gestures...');
        
        paperElement.addEventListener('touchstart', handleTouchStart, { passive: true });
        paperElement.addEventListener('touchmove', handleTouchMove, { passive: true });
        paperElement.addEventListener('touchend', handleTouchEnd);
        
        paperElement.addEventListener('mousedown', handleMouseDown);
        paperElement.addEventListener('mousemove', handleMouseMove);
        paperElement.addEventListener('mouseup', handleMouseUp);
        paperElement.addEventListener('mouseleave', handleMouseCancel);
        
        document.addEventListener('keydown', handleKeyDown);
        
        console.log('Swipe gestures initialized successfully');
    }
    
    function handleTouchStart(e) {
        if (displayMode === 'one-page') return;
        
        touchStartX = e.touches[0].clientX;
        touchEndX = touchStartX;
        swipeStartTime = Date.now();
        isSwiping = true;
    }
    
    function handleTouchMove(e) {
        if (!isSwiping || displayMode === 'one-page') return;
        
        touchEndX = e.touches[0].clientX;
    }
    
    function handleTouchEnd(e) {
        if (!isSwiping || displayMode === 'one-page') {
            isSwiping = false;
            return;
        }
        
        const swipeDistance = touchEndX - touchStartX;
        const swipeDuration = Date.now() - swipeStartTime;
        const minSwipeDistance = 50;
        const maxSwipeDuration = 500;
        
        if (swipeDuration > maxSwipeDuration) {
            isSwiping = false;
            return;
        }
        
        if (Math.abs(swipeDistance) < minSwipeDistance) {
            isSwiping = false;
            return;
        }
        
        if (swipeDistance > 0) {
            goToPreviousPage();
        } else {
            goToNextPage();
        }
        
        isSwiping = false;
    }
    
    function handleMouseDown(e) {
        if (displayMode === 'one-page') return;
        
        touchStartX = e.clientX;
        touchEndX = touchStartX;
        swipeStartTime = Date.now();
        isSwiping = true;
    }
    
    function handleMouseMove(e) {
        if (!isSwiping || displayMode === 'one-page') return;
        
        touchEndX = e.clientX;
    }
    
    function handleMouseUp(e) {
        if (!isSwiping || displayMode === 'one-page') {
            isSwiping = false;
            return;
        }
        
        const swipeDistance = touchEndX - touchStartX;
        const swipeDuration = Date.now() - swipeStartTime;
        const minSwipeDistance = 30;
        const maxSwipeDuration = 300;
        
        if (swipeDuration > maxSwipeDuration) {
            isSwiping = false;
            return;
        }
        
        if (Math.abs(swipeDistance) < minSwipeDistance) {
            isSwiping = false;
            return;
        }
        
        if (swipeDistance > 0) {
            goToPreviousPage();
        } else {
            goToNextPage();
        }
        
        isSwiping = false;
    }
    
    function handleMouseCancel() {
        isSwiping = false;
    }
    
    function handleKeyDown(e) {
        if (displayMode === 'one-page') return;
        
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            goToPreviousPage();
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            goToNextPage();
        }
    }
    
    function goToPreviousPage() {
        if (displayMode === 'one-page') return;
        
        const currentPageNum = parseInt(currentPage);
        if (currentPageNum > 1) {
            currentPage = (currentPageNum - 1).toString();
            localStorage.setItem('currentPage', currentPage);
            updateReportView();
            
            window.dispatchEvent(new CustomEvent('syncPageChange', { 
                detail: { 
                    page: parseInt(currentPage),
                    mode: displayMode 
                } 
            }));
        }
    }
    
    function goToNextPage() {
        if (displayMode === 'one-page') return;
        
        let totalPages = 1;
        switch(displayMode) {
            case 'two-page': totalPages = 2; break;
            case 'three-page': totalPages = 3; break;
            case 'four-page': totalPages = 4; break;
            case 'five-page': totalPages = 5; break;
        }
        
        const currentPageNum = parseInt(currentPage);
        if (currentPageNum < totalPages) {
            currentPage = (currentPageNum + 1).toString();
            localStorage.setItem('currentPage', currentPage);
            updateReportView();
            
            window.dispatchEvent(new CustomEvent('syncPageChange', { 
                detail: { 
                    page: parseInt(currentPage),
                    mode: displayMode 
                } 
            }));
        }
    }
    
    function showSwipeFeedback(message) {
        const existingFeedback = document.querySelector('.swipe-feedback');
        if (existingFeedback) existingFeedback.remove();
        
        const feedback = document.createElement('div');
        feedback.className = 'swipe-feedback';
        feedback.textContent = message;
        
        document.body.appendChild(feedback);
        
        setTimeout(() => {
            if (feedback.parentNode) feedback.remove();
        }, 800);
    }
    
    function showSwipeHints() {
        if (displayMode === 'one-page') return;
        
        if (localStorage.getItem('swipeHintsShown') === 'true') return;
        
        document.querySelectorAll('.swipe-hint').forEach(hint => hint.remove());
    }

    // ========== TABLE GENERATION ==========
     function generateTableRows() {
    console.log('üìä Generating table rows...');
    
    // Always load fresh data first
    loadAttendanceNames();
    
    const tbody = document.getElementById('report-table-body');
    if (!tbody) {
        console.error('‚ùå Table body not found!');
        return;
    }
    
    tbody.innerHTML = '';
    
    let startIndex, endIndex, displayOffset, rowsToGenerate;
    
    if (displayMode === 'one-page') {
        startIndex = 0;
        rowsToGenerate = Math.max(16, Math.min(16, rowHeaderNames.length));
        displayOffset = 1;
    } else {
        const pageNumber = parseInt(currentPage) - 1;
        startIndex = pageNumber * 20;
        rowsToGenerate = 20;
        displayOffset = startIndex + 1;
    }
    
    console.log(`Generating ${rowsToGenerate} rows starting at index ${startIndex}`);
    
    // Count actual names to assign proper numbering
    let actualNameCount = 0;
    const nameNumberMap = {}; // Map from index to display number
    
    // First pass: Count only names that have content
    for (let i = 0; i < rowsToGenerate; i += 2) {
        const actualIndex1 = startIndex + i;
        const actualIndex2 = startIndex + i + 1;
        
        const name1 = rowHeaderNames[actualIndex1] || '';
        const name2 = rowHeaderNames[actualIndex2] || '';
        
        if (name1 && name1.trim() !== '') {
            actualNameCount++;
            nameNumberMap[actualIndex1] = actualNameCount;
        }
        
        if (name2 && name2.trim() !== '') {
            actualNameCount++;
            nameNumberMap[actualIndex2] = actualNameCount;
        }
    }
    
    console.log(`Found ${actualNameCount} names with content`);
    
    // Second pass: Generate rows
    for (let i = 0; i < rowsToGenerate; i += 2) {
        const actualIndex1 = startIndex + i;
        const actualIndex2 = startIndex + i + 1;
        
        const name1 = rowHeaderNames[actualIndex1] || '';
        const name2 = rowHeaderNames[actualIndex2] || '';
        
        const hasName1 = name1 && name1.trim() !== '';
        const hasName2 = name2 && name2.trim() !== '';
        
        // Get display numbers (only if name exists)
        const displayNumber1 = hasName1 ? nameNumberMap[actualIndex1] || '' : '';
        const displayNumber2 = hasName2 ? nameNumberMap[actualIndex2] || '' : '';
        
        // Create first row
        const row1 = document.createElement('tr');
        row1.setAttribute('data-index', actualIndex1);
        row1.innerHTML = `
            <td style="text-align: center; ${!hasName1 ? 'background-color: white;' : ''}">
                ${hasName1 ? `<span>${displayNumber1}.</span>` : ''}
            </td>
            <td style="${!hasName1 ? 'background-color: white;' : ''}">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="text" 
                           class="name-input" 
                           value="${name1.replace(/"/g, '&quot;')}" 
                           data-index="${actualIndex1}"
                           placeholder="Nama"
                           autocomplete="off"
                           style="${!hasName1 ? 'color: #999;' : ''}">
                </div>
            </td>
            <td rowspan="2" style="${!hasName1 && !hasName2 ? 'background-color: white;' : ''}">
                ${hasName1 ? `<div class="signature-number">${displayNumber1}.</div>` : ''}
                <div class="signature-wrapper ${hasName1 ? '' : 'disabled'}" 
                     data-name="${name1.replace(/"/g, '&quot;')}" 
                     data-display-number="${displayNumber1}"
                     data-has-name="${hasName1}"
                     data-row-index="${actualIndex1}"
                     style="${!hasName1 ? 'opacity: 0.5;' : ''}">
                    <div class="signature" data-name="${name1.replace(/"/g, '&quot;')}" data-index="${actualIndex1}"></div>
                </div>
            </td>
            <td rowspan="2" style="${!hasName1 && !hasName2 ? 'background-color: white;' : ''}">
                ${hasName2 ? `<div class="signature-number">${displayNumber2}.</div>` : ''}
                <div class="signature-wrapper ${hasName2 ? '' : 'disabled'}" 
                     data-name="${name2.replace(/"/g, '&quot;')}" 
                     data-display-number="${displayNumber2}"
                     data-has-name="${hasName2}"
                     data-row-index="${actualIndex2}"
                     style="${!hasName2 ? 'opacity: 0.5;' : ''}">
                    <div class="signature" data-name="${name2.replace(/"/g, '&quot;')}" data-index="${actualIndex2}"></div>
                </div>
            </td>
            <td style="${!hasName1 ? 'background-color: white;' : ''}">
                <div class="keterangan-container">
                    ${hasName1 ? `<span class="keterangan-number">${displayNumber1}.</span>` : ''}
                    <select class="keterangan" data-name="${name1.replace(/"/g, '&quot;')}" data-index="${actualIndex1}" ${!hasName1 ? 'disabled' : ''}
                            style="${!hasName1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        <option value=""> </option>
                        <option value="I">I</option>
                        <option value="S">S</option>
                        <option value="TK">TK</option>
                    </select>
                </div>
            </td>
        `;
        tbody.appendChild(row1);
        
        // Create second row
        const row2 = document.createElement('tr');
        row2.setAttribute('data-index', actualIndex2);
        row2.innerHTML = `
            <td style="text-align: center; ${!hasName2 ? 'background-color: white;' : ''}">
                ${hasName2 ? `<span>${displayNumber2}.</span>` : ''}
            </td>
            <td style="${!hasName2 ? 'background-color: white;' : ''}">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="text" 
                           class="name-input" 
                           value="${name2.replace(/"/g, '&quot;')}" 
                           data-index="${actualIndex2}"
                           placeholder="Nama"
                           autocomplete="off"
                           style="${!hasName2 ? 'color: #999;' : ''}">
                </div>
            </td>
            <td style="${!hasName2 ? 'background-color: white;' : ''}">
                <div class="keterangan-container">
                    ${hasName2 ? `<span class="keterangan-number">${displayNumber2}.</span>` : ''}
                    <select class="keterangan" data-name="${name2.replace(/"/g, '&quot;')}" data-index="${actualIndex2}" ${!hasName2 ? 'disabled' : ''}
                            style="${!hasName2 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        <option value=""> </option>
                        <option value="I">I</option>
                        <option value="S">S</option>
                        <option value="TK">TK</option>
                    </select>
                </div>
            </td>
        `;
        tbody.appendChild(row2);
    }
    
    // IMPORTANT: Re-attach event listeners AFTER generating rows
    setTimeout(() => {
        attachEventListeners();
        loadSignaturesAndKeterangan();
        
        // Update signature numbers visibility
        updateSignatureNumbersVisibility();
    }, 0);
    
    console.log(`‚úÖ Table generated for ${currentDivision}_${currentGender} page ${currentPage}`);
}

    // ========== SIGNATURE & KETERANGAN FUNCTIONS ==========
    function loadSignaturesAndKeterangan() {
        const divisionKey = getFullDivisionKey('spreadsheetData');
        const data = JSON.parse(localStorage.getItem(divisionKey)) || {};
        
        console.log(`Loading signatures & keterangan for ${currentDivision}_${currentGender}:`, data);

        // Process each signature element
        document.querySelectorAll('.signature').forEach(div => {
            const name = div.dataset.name || '';
            const index = parseInt(div.dataset.index);
            const wrapper = div.closest('.signature-wrapper');
            const hasName = wrapper?.dataset.hasName === 'true';
            
            // Clear if no name or wrapper is disabled
            if (!hasName || !name || name.trim() === '') {
                div.innerHTML = '';
                return;
            }
            
            // Try to load signature
            if (data[name] && data[name].image) {
                const img = document.createElement('img');
                img.src = data[name].image;
                img.style.cssText = 'max-width:100%; max-height:100%; object-fit:contain; display: block;';
                div.innerHTML = '';
                div.appendChild(img);
            } else {
                // Try case-insensitive match
                const normalizedName = name.toLowerCase().trim();
                const matchingKey = Object.keys(data).find(key =>
                    key.toLowerCase().trim() === normalizedName
                );
                
                if (matchingKey && data[matchingKey]?.image) {
                    const img = document.createElement('img');
                    img.src = data[matchingKey].image;
                    img.style.cssText = 'max-width:100%; max-height:100%; object-fit:contain; display: block;';
                    div.innerHTML = '';
                    div.appendChild(img);
                    
                    // Update the data-name to match the stored key
                    div.dataset.name = matchingKey;
                    if (wrapper) {
                        wrapper.dataset.name = matchingKey;
                    }
                } else {
                    div.innerHTML = '';
                }
            }
        });
        
        // Process each keterangan select
        document.querySelectorAll('.keterangan').forEach(select => {
            const name = select.dataset.name || '';
            const index = parseInt(select.dataset.index);
            const nameInput = document.querySelector(`.name-input[data-index="${index}"]`);
            const hasName = nameInput && nameInput.value.trim() !== '';
            
            // Disable if no name
            if (!hasName || !name || name.trim() === '') {
                select.value = '';
                select.disabled = true;
                select.style.backgroundColor = '#fff';
                return;
            }
            
            // Enable and load value
            select.disabled = false;
            select.style.backgroundColor = '';
            
            // First check exact match
            if (data[name] && data[name].keterangan !== undefined) {
                select.value = data[name].keterangan;
            } else {
                // Try case-insensitive match
                const normalizedName = name.toLowerCase().trim();
                const matchingKey = Object.keys(data).find(key =>
                    key.toLowerCase().trim() === normalizedName &&
                    data[key].keterangan !== undefined
                );
                
                if (matchingKey) {
                    select.value = data[matchingKey].keterangan;
                    // Update data-name to match
                    select.dataset.name = matchingKey;
                    console.log(`Loaded keterangan for "${name}" from matching key "${matchingKey}": ${data[matchingKey].keterangan}`);
                } else {
                    // Keep existing value if any, otherwise set to empty
                    select.value = select.value || '';
                }
            }
        });
        
        updateSignatureIndicators();
    }
    
    function saveAttendanceNames() {
    const divisionKey = getFullDivisionKey('attendanceNames');
    localStorage.setItem(divisionKey, JSON.stringify(rowHeaderNames));
    console.log(`Saved names for ${currentDivision}_${currentGender}:`, rowHeaderNames.length, 'names');
    
    // Trigger auto-sync
    if (window.autoSyncManager) {
        window.autoSyncManager.queueSync('names');
    }
}

function saveAttendanceInfo() {
    const waktu = document.getElementById('waktu-input')?.value || "";
    const tempat = document.getElementById('tempat-input')?.value || "";
    const keterangan = document.getElementById('keterangan-input')?.value || "";
    
    const attendanceInfo = {
        waktu,
        tempat,
        keterangan
    };
    
    localStorage.setItem(getFullDivisionKey('attendanceInfo'), JSON.stringify(attendanceInfo));
    console.log(`Attendance info saved for ${currentDivision}_${currentGender}:`, attendanceInfo);
    
    // Trigger auto-sync
    if (window.autoSyncManager) {
        window.autoSyncManager.queueSync('info');
    }
}

function saveReportTitles() {
    const title1 = document.getElementById('report-title1')?.value || "";
    const title2 = document.getElementById('report-title2')?.value || "";
    const title3 = document.getElementById('report-title3')?.value || "";
    
    const reportTitles = [title1, title2, title3];
    localStorage.setItem(getFullDivisionKey('reportTitles'), JSON.stringify(reportTitles));
    console.log(`Report titles saved for ${currentDivision}_${currentGender}:`, reportTitles);
    
    // Trigger auto-sync
    if (window.autoSyncManager) {
        window.autoSyncManager.queueSync('titles');
    }
}

function setDynamicDate() {
    const dateDiv = document.getElementById('report-date');
    const savedData = localStorage.getItem(getFullDivisionKey('tanggalPresensi'));
    
    if (savedData) {
        dateDiv.value = savedData;
    } else {
        const today = new Date();
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jum\'at', 'Sabtu'];
        const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        dateDiv.value = `${days[today.getDay()]}, ${today.getDate()} ${months[today.getMonth()]} ${today.getFullYear()}`;
    }
    
    // Save date to localStorage
    if (dateDiv.value) {
        localStorage.setItem(getFullDivisionKey('tanggalPresensi'), dateDiv.value);
        
        // Trigger auto-sync
        if (window.autoSyncManager) {
            window.autoSyncManager.queueSync('date');
        }
    }
}

function saveKeterangan(name, keterangan) {
    if (!name || name.trim() === '') {
        console.warn('Cannot save keterangan for empty name');
        return;
    }
    
    const divisionKey = getFullDivisionKey('spreadsheetData');
    const data = JSON.parse(localStorage.getItem(divisionKey) || '{}');
    
    // Initialize if doesn't exist
    if (!data[name]) {
        data[name] = {};
    }
    
    // Save keterangan
    data[name].keterangan = keterangan;
    
    // Save back to localStorage
    localStorage.setItem(divisionKey, JSON.stringify(data));
    console.log(`Saved keterangan for "${name}": "${keterangan}" in ${divisionKey}`);
    
    // Trigger auto-sync
    if (window.autoSyncManager) {
        window.autoSyncManager.queueSync('signatures');
    }
    
    // Save to Firebase if available (redundant but ensures immediate save)
    if (window.dbManager && window.dbManager.isInitialized) {
        const signatureImage = data[name]?.image || '';
        
        window.dbManager.saveSignature(name, signatureImage, keterangan)
            .then(result => {
                if (result.success) {
                    console.log(`‚úÖ Firebase: Saved keterangan for "${name}"`);
                }
            })
            .catch(error => {
                console.error(`‚ùå Firebase: Error saving keterangan for "${name}":`, error);
            });
    }
}

    function updateSignatureAndKeteranganForIndex(index, newName) {
        const hasName = newName && newName.trim() !== '';
        
        // Find the signature wrapper for this index
        const signatureWrapper = document.querySelector(`.signature-wrapper[data-row-index="${index}"]`);
        
        if (signatureWrapper) {
            // Update wrapper attributes
            signatureWrapper.dataset.name = newName;
            signatureWrapper.dataset.hasName = hasName;
            
            // Update visual state
            if (hasName) {
                signatureWrapper.classList.remove('disabled');
                signatureWrapper.style.cursor = 'none';
                signatureWrapper.title = `Click to add signature for ${newName}`;
            } else {
                signatureWrapper.classList.add('disabled');
                signatureWrapper.style.cursor = 'not-allowed';
                signatureWrapper.title = 'Enter a name first to add signature';
                
                // Clear any existing signature display
                const signatureDiv = signatureWrapper.querySelector('.signature');
                if (signatureDiv) {
                    signatureDiv.innerHTML = '';
                    
                    // Also remove from localStorage if exists
                    const divisionKey = getFullDivisionKey('spreadsheetData');
                    const data = JSON.parse(localStorage.getItem(divisionKey)) || {};
                    if (data[newName]) {
                        delete data[newName];
                        localStorage.setItem(divisionKey, JSON.stringify(data));
                        
                        // Fire storage event to sync
                        window.dispatchEvent(new StorageEvent('storage', {
                            key: divisionKey,
                            newValue: JSON.stringify(data)
                        }));
                    }
                }
            }
            
            // Update the signature div
            const signatureDiv = signatureWrapper.querySelector('.signature');
            if (signatureDiv) {
                signatureDiv.dataset.name = newName;
            }
        }
        
        // Find and update keterangan select for this index
        const keteranganSelect = document.querySelector(`.keterangan[data-index="${index}"]`);
        if (keteranganSelect) {
            keteranganSelect.dataset.name = newName;
            
            if (hasName) {
                keteranganSelect.disabled = false;
                keteranganSelect.title = `Select keterangan for ${newName}`;
            } else {
                keteranganSelect.disabled = true;
                keteranganSelect.value = '';
                keteranganSelect.title = 'Enter a name first';
                
                // Clear keterangan from localStorage
                const divisionKey = getFullDivisionKey('spreadsheetData');
                const data = JSON.parse(localStorage.getItem(divisionKey)) || {};
                if (data[newName] && data[newName].keterangan) {
                    delete data[newName].keterangan;
                    
                    // If no image either, remove the entire entry
                    if (!data[newName].image) {
                        delete data[newName];
                    }
                    localStorage.setItem(divisionKey, JSON.stringify(data));
                }
            }
        }
        
        // Update the signature number display
        const signatureNumber = document.querySelector(`.signature-wrapper[data-row-index="${index}"] .signature-number`);
        if (signatureNumber) {
            if (!hasName) {
                signatureNumber.style.opacity = '0.5';
            } else {
                signatureNumber.style.opacity = '1';
            }
        }
        
        // Trigger storage update event
        window.dispatchEvent(new CustomEvent('storageUpdate'));
        
        console.log(`Updated signature and keterangan for ${currentDivision}_${currentGender} index ${index}: ${newName || '(empty)'}`);
    }

    function updateSignatureIndicators() {
        document.querySelectorAll('.signature-wrapper').forEach(wrapper => {
            const name = wrapper.dataset.name || '';
            const hasName = wrapper.dataset.hasName === 'true';
            const displayNumber = wrapper.dataset.displayNumber;
            
            // Remove existing event listener to avoid duplicates
            wrapper.onclick = null;
            
            // Set new event listener
            wrapper.onclick = (e) => {
                e.stopPropagation();
                
                if (!hasName || !name || name.trim() === '') {
                    // Try to find name from input
                    const rowIndex = parseInt(wrapper.dataset.rowIndex);
                    const nameInput = document.querySelector(`.name-input[data-index="${rowIndex}"]`);
                    
                    if (nameInput && nameInput.value.trim()) {
                        const actualName = nameInput.value.trim();
                        
                        // Update wrapper
                        wrapper.dataset.name = actualName;
                        wrapper.dataset.hasName = 'true';
                        wrapper.classList.remove('disabled');
                        
                        // Update signature div
                        const signatureDiv = wrapper.querySelector('.signature');
                        if (signatureDiv) {
                            signatureDiv.dataset.name = actualName;
                        }
                        
                        // Enable keterangan for this name
                        const keteranganSelect = document.querySelector(`.keterangan[data-index="${rowIndex}"]`);
                        if (keteranganSelect) {
                            keteranganSelect.disabled = false;
                            keteranganSelect.dataset.name = actualName;
                        }
                        
                        // Save the name
                        saveNameAtIndex(rowIndex, actualName);
                        
                        // Show signature modal - always enabled even without login
                        showSignatureModal(actualName);
                        return;
                    } else {
                        alert(`Please enter a name for number ${displayNumber} first!`);
                        
                        // Focus on the corresponding name input
                        if (nameInput) {
                            const isLoggedIn = document.body.classList.contains('user-logged-in');
                            if (isLoggedIn) {
                                nameInput.focus();
                                nameInput.select();
                            } else {
                                showNotification('Please login to enter names', 'warning');
                                setTimeout(() => {
                                    showLoginModal();
                                }, 500);
                            }
                        }
                        return;
                    }
                }
                
                // Show signature modal - always enabled even without login
                showSignatureModal(name);
            };
        });
    }

    // ========== SIGNATURE MODAL FUNCTION ==========
    function showSignatureModal(name) {
        console.log(`Opening signature modal for ${currentDivision}_${currentGender}:`, name);
        
        if (!window.SignaturePad) {
            console.error('SignaturePad library not loaded!');
            alert('Signature feature requires SignaturePad library. Please check your internet connection.');
            return;
        }
        
        // Check if name already has saved signature
        const divisionKey = getFullDivisionKey('spreadsheetData');
        const data = JSON.parse(localStorage.getItem(divisionKey)) || {};
        const hasExistingSignature = data[name] && data[name].image;
        
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay signature-modal-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        `;
        
        // Create modal content
        const modal = document.createElement('div');
        modal.className = 'signature-modal';
        modal.style.cssText = `
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            animation: modalPop 0.3s ease;
        `;
        
        modal.innerHTML = `
    <button class="close-modal-btn" style="
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: none;
        color: #666;
        z-index: 2;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    ">&times;</button>
    
    <h3 style="
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--text);
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        text-align: center;
        padding-right: 30px;
    ">Signature for: <span style="color: var(--text)">${name}</span></h3>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="display: inline-flex; gap: 15px; background: #f8f9fa; padding: 8px 15px; border-radius: 20px; font-size: 13px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <span class="material-symbols-outlined" style="font-size: 16px; color: var(--text);">
                    groups
                </span>
                <span style="font-weight: 500;">Division:</span>
                <span style="color: var(--secondary); font-weight: 600;">${currentDivision}</span>
            </div>
            <div style="height: 20px; width: 1px; background: #ddd;"></div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <span class="material-symbols-outlined" style="font-size: 16px; color: var(--text);">
                    person
                </span>
                <span style="font-weight: 500;">Gender:</span>
                <span style="color: var(--secondary); font-weight: 600;">${currentGender}</span>
            </div>
        </div>
    </div>
    
    <div class="signature-form-container">
        <!-- Canvas for signature -->
        <div style="margin-bottom: 30px; position: relative;">
            <label style="
                display: block;
                margin-bottom: 10px;
                font-weight: 500;
                color: var(--text);
                font-family: 'Poppins', sans-serif;
                text-align: center;
            ">Draw your signature below:</label>
            
            <canvas id="modal-signature-canvas" width="400" height="150" style="
                width: 100%;
                max-width: 400px;
                height: 200px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background: transparent;
                cursor: crosshair;
                display: block;
                margin: 0 auto;
                transition: border-color 0.3s ease;
                margin-top: 15px;
            "></canvas>
            
            <p style="
                text-align: center;
                margin-top: 10px;
                color: #666;
                font-size: 12px;
                font-family: 'Poppins', sans-serif;
            ">
                <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">
                    auto_fix
                </span>
                <span id="auto-save-notification" style="margin-left: 5px;">Auto-save: On</span>
            </p>
        </div>
        
        <!-- Existing signature preview (only show if signature exists) -->
        <div id="existing-signature-section" style="
            border-top: 2px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
            display: ${hasExistingSignature ? 'block' : 'none'};
            position: relative;
        ">
            <p style="
                margin-bottom: 15px;
                font-weight: 600;
                color: var(--text);
                font-family: 'Poppins', sans-serif;
                text-align: center;
            ">Current Signature:</p>
            
            <!-- Delete button container -->
            <div id="delete-button-container" style="
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 10;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <!-- Delete button will be inserted here -->
            </div>
            
            <!-- Signature container -->
            <div id="existing-signature-container" style="
                max-width: 250px;
                max-height: 120px;
                margin: 0 auto;
                padding: 10px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                background: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            ">
                <div id="existing-signature-img" style="
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                "></div>
            </div>
            
            <div style="text-align: center; margin-top: 10px;">
                <p style="
                    font-size: 11px;
                    color: #888;
                    font-family: 'Poppins', sans-serif;
                    margin: 5px 0;
                ">
                    <span class="material-symbols-outlined" style="font-size: 12px; vertical-align: middle;">
                        shield
                    </span>
                    This signature is saved only for ${currentDivision} ${currentGender}
                </p>
            </div>
        </div>
        
        <!-- Instructions section -->
        <div style="
            margin-top: 25px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        ">
            <p style="
                margin: 0;
                font-size: 12px;
                color: #666;
                font-family: 'Poppins', sans-serif;
                line-height: 1.5;
            ">
                <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle; margin-right: 5px;">
                    lightbulb
                </span>
                <strong>Note:</strong> Signatures are separated by Division and Gender. 
                Changing to a different division or gender will load different signatures.
            </p>
        </div>
    </div>
`;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        document.body.classList.add('modal-open');
        
        // Initialize signature pad
        const canvas = document.getElementById('modal-signature-canvas');
        let signaturePad;
        
        // Replace this section in showSignatureModal function:
try {
    signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)',
        penColor: 'rgb(51, 51, 51)',
        minWidth: 1.5,
        maxWidth: 3,
        throttle: 0,
        velocityFilterWeight: 0.7
    });
} catch (error) {
    console.error('Error initializing SignaturePad:', error);
    alert('Error initializing signature pad. Please refresh the page.');
    closeSignatureModal();
    return;
}
        
// Auto-save signature
let saveTimeout;
let lastSaveDataUrl = '';
let drawTimer;

function autoSaveSignature() {
    if (!signaturePad.isEmpty()) {
        clearTimeout(saveTimeout);
        
        saveTimeout = setTimeout(() => {
            const signatureDataUrl = signaturePad.toDataURL('image/png');
            
            // Only save if the signature has actually changed
            if (signatureDataUrl === lastSaveDataUrl) {
                console.log('Signature unchanged, skipping save');
                return;
            }
            
            lastSaveDataUrl = signatureDataUrl;
            
            try {
                // Save to localStorage with division key
                let localData = JSON.parse(localStorage.getItem(divisionKey)) || {};
                if (!localData[name]) {
                    localData[name] = {};
                }
                localData[name].image = signatureDataUrl;
                // Keep existing keterangan if it exists
                if (data[name] && data[name].keterangan) {
                    localData[name].keterangan = data[name].keterangan;
                }
                localStorage.setItem(divisionKey, JSON.stringify(localData));
                
                // TRIGGER AUTO-SYNC
                if (window.autoSyncManager) {
                    window.autoSyncManager.queueSync('signatures');
                }
                
                // Also save immediately to Firebase
                if (window.dbManager && window.dbManager.isInitialized) {
                    window.dbManager.saveSignature(
                        name,
                        signatureDataUrl,
                        data[name]?.keterangan || ''
                    ).then(result => {
                        if (result.success) {
                            console.log(`‚úÖ Signature auto-saved for ${name}`);
                            
                            // Show auto-save notification
                            const autoSaveNotification = document.getElementById('auto-save-notification');
                            if (autoSaveNotification) {
                                autoSaveNotification.textContent = '‚úì Saved';
                                autoSaveNotification.style.color = 'var(--secondary)';
                                setTimeout(() => {
                                    autoSaveNotification.textContent = 'Auto-save: On';
                                    autoSaveNotification.style.color = '#666';
                                }, 1500);
                            }
                        }
                    });
                }
                
                // Trigger events
                window.dispatchEvent(new StorageEvent('storage', {
                    key: divisionKey,
                    newValue: JSON.stringify(localData)
                }));
                
                window.dispatchEvent(new CustomEvent('signatureSaved'));
                window.dispatchEvent(new CustomEvent('storageUpdate'));
                
                // Update existing signature section
                updateExistingSignatureSection(signatureDataUrl);
                
                console.log(`‚úÖ Signature auto-saved for ${currentDivision}_${currentGender}:`, name);
                
            } catch (error) {
                console.error('Error auto-saving signature:', error);
            }
        }, 500); // Reduced to 500ms for faster auto-save
    }
}
        
        // Function to update existing signature section
        function updateExistingSignatureSection(signatureDataUrl) {
            const existingSection = document.getElementById('existing-signature-section');
            const existingImg = document.getElementById('existing-signature-img');
            
            if (!existingSection || !existingImg) return;
            
            existingSection.style.display = 'block';
            
            // Update the image
            existingImg.innerHTML = `
                <img src="${signatureDataUrl}" 
                     style="
                         max-width: 100%;
                         max-height: 100px;
                         object-fit: contain;
                         display: block;
                     ">
            `;
            
            // Ensure delete button exists
            if (!document.querySelector('#modal-delete-signature-icon')) {
                createDeleteButton();
            }
        }
        
        // Function to create delete button
        function createDeleteButton() {
            const deleteContainer = document.getElementById('delete-button-container');
            if (!deleteContainer) return;
            
            // Clear existing delete button
            deleteContainer.innerHTML = '';
            
            // Create delete button icon
            const deleteBtn = document.createElement('button');
            deleteBtn.id = 'modal-delete-signature-icon';
            deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">delete</span>';
            deleteBtn.title = "Delete signature";
            deleteBtn.style.cssText = `
                background: transparent;
                border: none;
                cursor: none;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                opacity: 0.7;
                width: 40px;
                height: 40px;
                border-radius: 50%;
            `;
            
            // Add hover effects for delete button
            deleteBtn.addEventListener('mouseenter', () => {
                deleteBtn.style.opacity = '1';
                deleteBtn.style.color = '#666';
            });
            
            deleteBtn.addEventListener('mouseleave', () => {
                deleteBtn.style.opacity = '0.7';
                deleteBtn.style.backgroundColor = 'transparent';
                deleteBtn.style.color = '#666';
            });
            
            // Add delete functionality - WITH AUTO-CLOSE
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!confirm(`Are you sure you want to delete the signature for "${name}"?`)) {
                    return;
                }
                
                // Disable button during deletion
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">hourglass_empty</span>';
                deleteBtn.style.cursor = 'wait';
                
                try {
                    // Delete from localStorage with division key
                    let localData = JSON.parse(localStorage.getItem(divisionKey)) || {};
                    if (localData[name]) {
                        // Remove only the image
                        delete localData[name].image;
                        
                        // If no keterangan either, remove the entire entry
                        if (!localData[name].keterangan) {
                            delete localData[name];
                        }
                        
                        localStorage.setItem(divisionKey, JSON.stringify(localData));
                    }
                    
                    // Delete from Firebase if available
                    if (window.dbManager) {
                        await window.dbManager.deleteSignature(name);
                    }
                    
                    // Trigger events
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: divisionKey,
                        newValue: JSON.stringify(localData),
                        url: window.location.href
                    }));
                    
                    window.dispatchEvent(new CustomEvent('signatureDeleted'));
                    window.dispatchEvent(new CustomEvent('storageUpdate'));
                    
                    // CLOSE MODAL IMMEDIATELY AFTER SUCCESSFUL DELETION
                    closeSignatureModal();
                    
                    // Update the table display
                    if (typeof loadSignaturesAndKeterangan === 'function') {
                        loadSignaturesAndKeterangan();
                    }
                    
                    // Show global notification
                    showNotification('Signature deleted successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting signature:', error);
                    
                    // Restore delete button
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">delete</span>';
                    deleteBtn.style.cursor = 'none';
                    
                    alert('Error deleting signature. Please try again.');
                }
            });
            
            // Add delete button to the separate container
            deleteContainer.appendChild(deleteBtn);
        }
        
        // Load existing signature if it exists
        if (hasExistingSignature && data[name].image) {
            const existingImg = document.getElementById('existing-signature-img');
            existingImg.innerHTML = `
                <img src="${data[name].image}" 
                     style="
                         max-width: 100%;
                         max-height: 100px;
                         object-fit: contain;
                         display: block;
                     ">
            `;
            
            // Set last save data URL
            lastSaveDataUrl = data[name].image;
            
            // Create delete button
            createDeleteButton();
        }
        
        // Event listeners
        const closeBtn = modal.querySelector('.close-modal-btn');
        closeBtn.addEventListener('click', closeSignatureModal);
        
        // Hover effect for close button
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.backgroundColor = 'transparent';
            closeBtn.style.color = '#333';
        });
        
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.backgroundColor = 'transparent';
            closeBtn.style.color = '#666';
        });
        
        // Close on overlay click
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeSignatureModal();
            }
        });
        
        // Close on Escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                closeSignatureModal();
            }
        };
        document.addEventListener('keydown', handleEscape);
      
        // Canvas interaction listeners
        canvas.addEventListener('mousedown', () => {
            canvas.style.borderColor = 'var(--secondary)';
        });
        
        canvas.addEventListener('mouseup', () => {
            canvas.style.borderColor = '#ddd';
            updateButtonStates();
        });
        
        canvas.addEventListener('touchend', () => {
            setTimeout(() => {
                updateButtonStates();
            }, 100);
        });
        
        // Signature pad events
        signaturePad.onBegin = () => {
            canvas.style.borderColor = 'var(--secondary)';
            // Clear any previous save timeout when starting new drawing
            clearTimeout(saveTimeout);
            clearTimeout(drawTimer);
        };
        
        signaturePad.onEnd = () => {
            canvas.style.borderColor = '#ddd';
            updateButtonStates();
            
            // Auto-save immediately after finishing drawing
            autoSaveSignature();
            
            // Also save after a short delay to catch any final strokes
            setTimeout(() => {
                if (!signaturePad.isEmpty()) {
                    autoSaveSignature();
                }
            }, 300);
        };
        
        // More frequent auto-save during drawing
        canvas.addEventListener('mousemove', (e) => {
            if (e.buttons === 1) { // Only when mouse button is pressed (drawing)
                clearTimeout(drawTimer);
                drawTimer = setTimeout(() => {
                    if (!signaturePad.isEmpty()) {
                        autoSaveSignature();
                    }
                }, 1000); // Save every 1 second while drawing
            }
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            clearTimeout(drawTimer);
            drawTimer = setTimeout(() => {
                if (!signaturePad.isEmpty()) {
                    autoSaveSignature();
                }
            }, 1000); // Save every 1 second while drawing
        }, { passive: false });
        
        // Initialize button states
        updateButtonStates();
        
        // Resize canvas for high DPI displays
        let currentSignatureData = null;
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const currentWidth = canvas.width;
            const currentHeight = canvas.height;
            
            // Store current signature before resize
            if (!signaturePad.isEmpty()) {
                currentSignatureData = signaturePad.toData();
            }
            
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            
            // Clear the signature pad
            signaturePad.clear();
            
            // Restore signature if it existed
            if (currentSignatureData) {
                signaturePad.fromData(currentSignatureData);
                currentSignatureData = null;
            }
            
            updateButtonStates();
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Close modal function with animation
        function closeSignatureModal() {
            // Ensure final auto-save
            if (signaturePad && !signaturePad.isEmpty()) {
                autoSaveSignature();
                
                // Wait a bit for save to complete
                setTimeout(() => {
                    actuallyCloseModal();
                }, 500);
            } else {
                actuallyCloseModal();
            }
            
            function actuallyCloseModal() {
                // Clear any pending save timeout
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                
                if (drawTimer) {
                    clearTimeout(drawTimer);
                }
                
                // Remove resize listener
                window.removeEventListener('resize', resizeCanvas);
                
                // Remove event listeners
                document.removeEventListener('keydown', handleEscape);
                
                // Animate modal out
                modal.style.animation = 'modalPopOut 0.3s ease forwards';
                overlay.style.animation = 'fadeOut 0.3s ease forwards';
                
                setTimeout(() => {
                    if (overlay.parentNode) {
                        document.body.removeChild(overlay);
                        document.body.classList.remove('modal-open');
                        
                        // Trigger update of signatures in table
                        window.dispatchEvent(new CustomEvent('modalClosed'));
                    }
                }, 300);
            }
        }
    }

    // ========== DIVISION & GENDER MANAGEMENT ==========
    function updateDivisionUI() {
        const divisionSelect = document.getElementById('division-select');
        if (divisionSelect) {
            divisionSelect.value = currentDivision;
        }
        
        // Update page toggle label to show division
        const toggleLabel = document.getElementById('reportToggleLabel');
        if (toggleLabel) {
            if (displayMode === 'one-page') {
                toggleLabel.textContent = `All Names - ${currentDivision}`;
            } else {
                toggleLabel.textContent = `${currentDivision} - Page ${currentPage} of ${getTotalPages()}`;
            }
        }
    }
    
    function getTotalPages() {
        switch(displayMode) {
            case 'one-page': return 1;
            case 'two-page': return 2;
            case 'three-page': return 3;
            case 'four-page': return 4;
            case 'five-page': return 5;
            default: return 1;
        }
    }
    
    function changeDivision(newDivision) {
        if (newDivision === currentDivision) return;
        
        console.log(`Changing division from ${currentDivision} to ${newDivision}`);
        
        // Save current division data before switching
        saveDivisionData();
        
        // Update current division
        currentDivision = newDivision;
        localStorage.setItem('currentDivision', currentDivision);
        
        // Load new division data
        loadDivisionData();
        
        // Update UI
        updateDivisionUI();
        updateGenderUI();
        updateReportView();
        
        // Show notification
        showNotification(`Switched to ${currentDivision} division`, 'info');
        
        // Close dropdown
        document.getElementById('dropdown-menu').style.display = 'none';
        const overlay = document.querySelector('.dropdown-overlay');
        if (overlay) overlay.style.display = 'none';
    }
    
    function setupDivisionSelector() {
        const divisionSelect = document.getElementById('division-select');
        if (divisionSelect) {
            divisionSelect.value = currentDivision;
            
            divisionSelect.addEventListener('change', function() {
                changeDivision(this.value);
            });
        }
        
        updateDivisionUI();
    }

    function updateGenderUI() {
        const genderSelect = document.getElementById('gender-select');
        const genderSection = document.getElementById('gender-section');
        
        if (genderSelect) {
            genderSelect.value = currentGender;
        }
        
        // Always show gender section
        if (genderSection) {
            genderSection.style.display = 'block';
        }
        
        // Update page toggle label to show gender
        const toggleLabel = document.getElementById('reportToggleLabel');
        if (toggleLabel) {
            // Remove existing gender indicator
            const existingGenderIndicator = document.getElementById('gender-indicator');
            if (existingGenderIndicator) {
                existingGenderIndicator.remove();
            }
            
            // Add gender indicator
            const genderIndicator = document.createElement('span');
            genderIndicator.id = 'gender-indicator';
            genderIndicator.textContent = currentGender;
            genderIndicator.style.marginLeft = '4px';
            genderIndicator.style.padding = '2px 6px';
            genderIndicator.style.background = 'var(--text)';
            genderIndicator.style.color = 'white';
            genderIndicator.style.borderRadius = '3px';
            genderIndicator.style.fontSize = '11px';
            genderIndicator.style.fontWeight = '500';
            
            // Add it after division indicator or at the end
            const divisionIndicator = document.getElementById('division-indicator');
            if (divisionIndicator) {
                divisionIndicator.parentNode.insertBefore(genderIndicator, divisionIndicator.nextSibling);
            } else {
                toggleLabel.appendChild(genderIndicator);
            }
        }
    }

    function changeGender(newGender) {
        if (newGender === currentGender) return;
        
        console.log(`Changing gender from ${currentGender} to ${newGender}`);
        
        // Save current gender data before switching
        saveDivisionData();
        
        // Update current gender
        currentGender = newGender;
        localStorage.setItem('currentGender', currentGender);
        
        // Load new gender data
        loadDivisionData();
        
        // Update UI
        updateGenderUI();
        updateReportView();
        
        // Show notification
        showNotification(`Switched to ${currentGender}`, 'info');
    }

    function setupGenderSelector() {
        const genderSelect = document.getElementById('gender-select');
        if (genderSelect) {
            genderSelect.value = currentGender;
            
            genderSelect.addEventListener('change', function() {
                changeGender(this.value);
                
                // Close dropdown after selection
                setTimeout(() => {
                    document.getElementById('dropdown-menu').style.display = 'none';
                    const overlay = document.querySelector('.dropdown-overlay');
                    if (overlay) overlay.style.display = 'none';
                }, 300);
            });
        }
        
        updateGenderUI();
    }

    // ========== LOGIN UI FUNCTIONS ==========
    function updateLoginUI(isLoggedIn, userInfo = null) {
        const loginButton = document.querySelector('#dropdown-login-button');
        const body = document.body;
        
        if (isLoggedIn && userInfo) {
            // Update dropdown button
            if (loginButton) {
                loginButton.innerHTML = `
                    <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px; margin-right: 8px;">
                        logout
                    </span>
                    Logout
                    <div class="login-user-info">${userInfo.email || userInfo.displayName}</div>
                `;
                loginButton.classList.add('logged-in');
                loginButton.onclick = handleLogout;
            }
            
            // Add logged-in class to body
            body.classList.add('user-logged-in');
            
            // Enable editing of inputs
            enableInputEditing(true);
            
            // Save login state
            localStorage.setItem('userLoggedIn', 'true');
            if (userInfo) {
                localStorage.setItem('userInfo', JSON.stringify(userInfo));
            }
            
        } else {
            // Update dropdown button
            if (loginButton) {
                loginButton.innerHTML = `
                    <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px; margin-right: 8px;">
                        login
                    </span>
                    Login
                `;
                loginButton.classList.remove('logged-in');
                loginButton.onclick = showLoginModal;
            }
            
            // Remove logged-in class from body
            body.classList.remove('user-logged-in');
            
            // Disable editing of inputs
            enableInputEditing(false);
            
            // Clear login state
            localStorage.removeItem('userLoggedIn');
            localStorage.removeItem('userInfo');
        }
    }

    // Handle logout
    function handleLogout() {
        // Clear any Firebase auth
        if (window.firebaseAuth && window.firebaseAuth.logout) {
            window.firebaseAuth.logout();
        }
        
        // Clear local auth
        localStorage.removeItem('currentUser');
        
        // Update UI
        updateLoginUI(false);
        
        // Close dropdown
        document.getElementById('dropdown-menu').style.display = 'none';
        const overlay = document.querySelector('.dropdown-overlay');
        if (overlay) overlay.style.display = 'none';
        
        showNotification('Logged out successfully', 'info');
    }

    // Enable/disable input editing
    function enableInputEditing(enabled) {
        const titleInputs = document.querySelectorAll('.title-input');
        const infoInputs = document.querySelectorAll('.info-input');
        const nameInputs = document.querySelectorAll('.name-input');
        const dateInput = document.querySelector('.date-input');
        
        if (enabled) {
            // Enable editing
            titleInputs.forEach(input => {
                input.disabled = false;
                input.style.cursor = 'text';
                input.style.backgroundColor = 'transparent';
            });
            
            infoInputs.forEach(input => {
                input.disabled = false;
                input.style.cursor = 'text';
                input.style.backgroundColor = 'transparent';
            });
            
            nameInputs.forEach(input => {
                input.disabled = false;
                input.style.cursor = 'text';
                input.style.backgroundColor = 'transparent';
            });
            
            if (dateInput) {
                dateInput.disabled = false;
                dateInput.style.cursor = 'text';
                dateInput.style.backgroundColor = 'transparent';
            }
        } else {
            // Disable editing (but keep signatures enabled)
            titleInputs.forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                if (!input.matches(':focus')) {
                    input.style.backgroundColor = 'transparent';
                }
            });
            
            infoInputs.forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                if (!input.matches(':focus')) {
                    input.style.backgroundColor = 'transparent';
                }
            });
            
            nameInputs.forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                if (!input.matches(':focus')) {
                    input.style.backgroundColor = 'transparent';
                }
            });
            
            if (dateInput) {
                dateInput.disabled = true;
                dateInput.style.cursor = 'not-allowed';
                if (!dateInput.matches(':focus')) {
                    dateInput.style.backgroundColor = 'transparent';
                }
            }
        }
    }

    // Check login status on page load
    function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
        let userInfo = null;
        
        try {
            userInfo = JSON.parse(localStorage.getItem('userInfo') || 'null');
        } catch (e) {
            console.log('No valid user info found');
        }
        
        // Check Firebase auth if available
        if (window.firebaseAuth && window.firebaseAuth.isLoggedIn && window.firebaseAuth.getUserProfile) {
            const firebaseLoggedIn = window.firebaseAuth.isLoggedIn();
            if (firebaseLoggedIn && !isLoggedIn) {
                // Firebase user is logged in but our local state isn't set
                const profile = window.firebaseAuth.getUserProfile();
                updateLoginUI(true, profile);
                return;
            }
        }
        
        updateLoginUI(isLoggedIn, userInfo);
    }

    // ========== EVENT LISTENERS SETUP ==========
    function setupHamburgerMenu() {
        hamburgerMenu.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = dropdownMenu.style.display === 'block';
            dropdownMenu.style.display = isVisible ? 'none' : 'block';
            
            let overlay = document.querySelector('.dropdown-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'dropdown-overlay';
                document.body.appendChild(overlay);
            }
            overlay.style.display = isVisible ? 'none' : 'block';
            
            // Update division selector value when opening dropdown
            if (!isVisible) {
                const divisionSelect = document.getElementById('division-select');
                if (divisionSelect) {
                    divisionSelect.value = currentDivision;
                }
            }
        });

        document.querySelectorAll('.dropdown-item:not(.login-button):not(.dropdown-section)').forEach(item => {
            item.addEventListener('click', () => {
                const value = item.getAttribute('data-value');
                const validModes = ['one-page', 'two-page', 'three-page', 'four-page', 'five-page'];
                
                if (validModes.includes(value)) {
                    currentPage = '1';
                    localStorage.setItem('currentPage', currentPage);
                    
                    displayMode = value;
                    localStorage.setItem('displayMode', displayMode);
                    updateReportView();
                    
                    dropdownMenu.style.display = 'none';
                    document.querySelector('.dropdown-overlay').style.display = 'none';
                    
                    window.dispatchEvent(new CustomEvent('displayModeChange', { 
                        detail: { 
                            mode: displayMode,
                            page: parseInt(currentPage)
                        } 
                    }));
                }
            });
        });

        // Add login button listener
        const loginButton = document.querySelector('#dropdown-login-button');
        if (loginButton) {
            // Set initial click handler
            if (loginButton.classList.contains('logged-in')) {
                loginButton.onclick = handleLogout;
            } else {
                loginButton.onclick = showLoginModal;
            }
            
            loginButton.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.style.display = 'none';
                const overlay = document.querySelector('.dropdown-overlay');
                if (overlay) overlay.style.display = 'none';
            });
        }

        document.addEventListener('click', (e) => {
            if (!hamburgerMenu.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.style.display = 'none';
                const overlay = document.querySelector('.dropdown-overlay');
                if (overlay) overlay.style.display = 'none';
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                dropdownMenu.style.display = 'none';
                const overlay = document.querySelector('.dropdown-overlay');
                if (overlay) overlay.style.display = 'none';
            }
        });
    }
    
    function initializeButtonPositions() {
        if (hamburgerMenu) {
            hamburgerMenu.style.position = 'fixed';
            hamburgerMenu.style.top = '15px';
            hamburgerMenu.style.right = '20px';
            hamburgerMenu.style.zIndex = '1001';
        }

        if (dropdownMenu) {
            dropdownMenu.style.position = 'fixed';
            dropdownMenu.style.top = '60px';
            dropdownMenu.style.right = '20px';
            dropdownMenu.style.zIndex = '1002';
        }
    }

    function attachEventListeners() {
    console.log('üîó Attaching event listeners...');
    
    // Clear all existing listeners first
    document.querySelectorAll('.name-input').forEach(input => {
        // Replace the input with a clone to remove old listeners
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
    });
    
    // Attach listeners to name inputs
    document.querySelectorAll('.name-input').forEach(input => {
        attachNameInputListeners(input);
    });
    
    // Attach listeners to keterangan selects
    document.querySelectorAll('.keterangan').forEach(select => {
        attachKeteranganListeners(select);
    });
    
    // Setup info and title listeners
    setupInfoInputListeners();
    setupTitleInputListeners();
    setupDateInputListeners();
    
    console.log('‚úÖ Event listeners attached');
}

function attachNameInputListeners(input) {
    const index = parseInt(input.dataset.index);
    
    // Focus handler
    input.addEventListener('focus', function(e) {
        const isLoggedIn = document.body.classList.contains('user-logged-in');
        if (!isLoggedIn) {
            showNotification('Please login to edit names', 'warning');
            this.blur();
            
            setTimeout(() => {
                showLoginModal();
            }, 500);
            
            e.preventDefault();
            return false;
        }
        
        if (this.value.trim()) {
            const length = this.value.length;
            this.setSelectionRange(length, length);
        }
    });
    
    // Change handler (for explicit changes)
    input.addEventListener('change', function(e) {
        const newName = this.value.trim();
        console.log(`üìù Name changed at index ${index}: "${rowHeaderNames[index]}" -> "${newName}"`);
        
        // Only save if actually changed
        if (rowHeaderNames[index] !== newName) {
            saveNameAtIndex(index, newName);
            updateSignatureAndKeteranganForIndex(index, newName);
        }
    });
    
    // Blur handler (when user leaves field)
    input.addEventListener('blur', function(e) {
        const newName = this.value.trim();
        
        // Only save if actually changed
        if (rowHeaderNames[index] !== newName) {
            saveNameAtIndex(index, newName);
            updateSignatureAndKeteranganForIndex(index, newName);
        }
    });
    
    // Input handler (real-time with debounce)
    let inputTimeout;
    input.addEventListener('input', function(e) {
        clearTimeout(inputTimeout);
        
        inputTimeout = setTimeout(() => {
            const newName = this.value.trim();
            
            // Only save if actually changed
            if (rowHeaderNames[index] !== newName) {
                saveNameAtIndex(index, newName);
                updateSignatureAndKeteranganForIndex(index, newName);
            }
        }, 500); // 500ms debounce
    });
    
    // Enter key handler
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const newName = this.value.trim();
            
            if (rowHeaderNames[index] !== newName) {
                saveNameAtIndex(index, newName);
                updateSignatureAndKeteranganForIndex(index, newName);
            }
            
            // Move to next input
            moveToNextInput(this);
        }
    });
}

function attachKeteranganListeners(select) {
    const index = parseInt(select.dataset.index);
    const name = select.dataset.name;
    
    select.addEventListener('change', function() {
        const value = this.value;
        
        if (name && name.trim() !== '') {
            console.log(`üìù Keterangan changed for "${name}": "${value}"`);
            saveKeterangan(name, value);
        }
    });
    
    // Also save on blur
    select.addEventListener('blur', function() {
        const value = this.value;
        
        if (name && name.trim() !== '') {
            saveKeterangan(name, value);
        }
    });
}

function moveToNextInput(currentInput) {
    const allInputs = Array.from(document.querySelectorAll('.name-input'))
        .sort((a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index));
    
    const currentIndex = allInputs.indexOf(currentInput);
    
    if (currentIndex < allInputs.length - 1) {
        const nextInput = allInputs[currentIndex + 1];
        nextInput.focus();
        nextInput.select();
    } else {
        // Add new row if at the end
        const lastIndex = rowHeaderNames.length;
        saveNameAtIndex(lastIndex, '');
        
        // Focus on new input after a delay
        setTimeout(() => {
            const newInput = document.querySelector(`.name-input[data-index="${lastIndex}"]`);
            if (newInput) {
                newInput.focus();
                newInput.select();
            }
        }, 100);
    }
}
    
    function setupInfoInputListeners() {
    const waktuInput = document.getElementById('waktu-input');
    const tempatInput = document.getElementById('tempat-input');
    const keteranganInput = document.getElementById('keterangan-input');
    
    const setupAutoSync = (input) => {
        input.addEventListener('change', saveAttendanceInfo);
        input.addEventListener('blur', saveAttendanceInfo);
        input.addEventListener('input', () => {
            clearTimeout(input.syncTimeout);
            input.syncTimeout = setTimeout(saveAttendanceInfo, 1000);
        });
    };
    
    if (waktuInput) setupAutoSync(waktuInput);
    if (tempatInput) setupAutoSync(tempatInput);
    if (keteranganInput) setupAutoSync(keteranganInput);
}

function setupTitleInputListeners() {
    const title1 = document.getElementById('report-title1');
    const title2 = document.getElementById('report-title2');
    const title3 = document.getElementById('report-title3');
    
    const setupAutoSync = (input) => {
        input.addEventListener('change', saveReportTitles);
        input.addEventListener('blur', saveReportTitles);
        input.addEventListener('input', () => {
            clearTimeout(input.syncTimeout);
            input.syncTimeout = setTimeout(saveReportTitles, 1000);
        });
    };
    
    if (title1) setupAutoSync(title1);
    if (title2) setupAutoSync(title2);
    if (title3) setupAutoSync(title3);
}

function setupDateInputListeners() {
    const dateInput = document.querySelector('.date-input');
    
    if (dateInput) {
        dateInput.addEventListener('change', () => {
            if (dateInput.value) {
                localStorage.setItem(getFullDivisionKey('tanggalPresensi'), dateInput.value);
                
                // Trigger auto-sync
                if (window.autoSyncManager) {
                    window.autoSyncManager.queueSync('date');
                }
            }
        });
        
        dateInput.addEventListener('blur', () => {
            if (dateInput.value) {
                localStorage.setItem(getFullDivisionKey('tanggalPresensi'), dateInput.value);
                
                // Trigger auto-sync
                if (window.autoSyncManager) {
                    window.autoSyncManager.queueSync('date');
                }
            }
        });
        
        dateInput.addEventListener('input', () => {
            clearTimeout(dateInput.syncTimeout);
            dateInput.syncTimeout = setTimeout(() => {
                if (dateInput.value) {
                    localStorage.setItem(getFullDivisionKey('tanggalPresensi'), dateInput.value);
                    
                    // Trigger auto-sync
                    if (window.autoSyncManager) {
                        window.autoSyncManager.queueSync('date');
                    }
                }
            }, 1000);
        });
    }
}
    
    function setupTitleInputListeners() {
        const title1 = document.getElementById('report-title1');
        const title2 = document.getElementById('report-title2');
        const title3 = document.getElementById('report-title3');
        
        if (title1) {
            title1.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit titles', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            title1.addEventListener('change', saveReportTitles);
            title1.addEventListener('blur', saveReportTitles);
        }
        
        if (title2) {
            title2.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit titles', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            title2.addEventListener('change', saveReportTitles);
            title2.addEventListener('blur', saveReportTitles);
        }
        
        if (title3) {
            title3.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit titles', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            title3.addEventListener('change', saveReportTitles);
            title3.addEventListener('blur', saveReportTitles);
        }
    }
    
    // Add to your existing event listeners setup
function setupFirebaseUpdateListeners() {
    console.log('üîó Setting up Firebase update listeners...');
    
    // Listen for names updates from Firebase
    window.addEventListener('firebaseNamesUpdate', (event) => {
        const { names, division, gender } = event.detail;
        
        // Only update if it's the current division/gender
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        
        if (division === currentDivision && gender === currentGender) {
            console.log('üîÑ Updating names from Firebase event');
            rowHeaderNames = names;
            forceUpdateTableRows();
        }
    });
    
    // Listen for titles updates from Firebase
    window.addEventListener('firebaseTitlesUpdate', (event) => {
        const { titles, division, gender } = event.detail;
        
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        
        if (division === currentDivision && gender === currentGender) {
            console.log('üîÑ Updating titles from Firebase event');
            
            // Update title inputs
            const title1 = document.getElementById('report-title1');
            const title2 = document.getElementById('report-title2');
            const title3 = document.getElementById('report-title3');
            
            if (title1 && titles[0] !== undefined) title1.value = titles[0];
            if (title2 && titles[1] !== undefined) title2.value = titles[1];
            if (title3 && titles[2] !== undefined) title3.value = titles[2];
        }
    });
    
    // Listen for info updates from Firebase
    window.addEventListener('firebaseInfoUpdate', (event) => {
        const { info, division, gender } = event.detail;
        
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        
        if (division === currentDivision && gender === currentGender) {
            console.log('üîÑ Updating info from Firebase event');
            
            // Update info inputs
            const waktuInput = document.getElementById('waktu-input');
            const tempatInput = document.getElementById('tempat-input');
            const keteranganInput = document.getElementById('keterangan-input');
            
            if (waktuInput && info.waktu !== undefined) waktuInput.value = info.waktu;
            if (tempatInput && info.tempat !== undefined) tempatInput.value = info.tempat;
            if (keteranganInput && info.keterangan !== undefined) keteranganInput.value = info.keterangan;
        }
    });
    
    // Listen for date updates from Firebase
    window.addEventListener('firebaseDateUpdate', (event) => {
        const { date, division, gender } = event.detail;
        
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        
        if (division === currentDivision && gender === currentGender) {
            console.log('üîÑ Updating date from Firebase event');
            
            // Update date input
            const dateInput = document.querySelector('.date-input');
            if (dateInput && date) {
                dateInput.value = date;
            }
        }
    });
    
    // Listen for signatures updates from Firebase
    window.addEventListener('firebaseSignaturesUpdate', (event) => {
        const { division, gender } = event.detail;
        
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        
        if (division === currentDivision && gender === currentGender) {
            console.log('üîÑ Updating signatures from Firebase event');
            loadSignaturesAndKeterangan();
        }
    });
    
    console.log('‚úÖ Firebase update listeners set up');
}

    // ========== EXTERNAL EVENT LISTENERS ==========
    window.addEventListener('syncPageChange', (event) => {
        if (displayMode !== 'one-page') {
            currentPage = event.detail.page.toString();
            localStorage.setItem('currentPage', currentPage);
            updateReportView();
        }
    });

    window.addEventListener('displayModeChange', (event) => {
        displayMode = event.detail.mode;
        localStorage.setItem('displayMode', displayMode);
        updateReportView();
    });
    
    window.addEventListener('signatureSaved', () => {
        loadSignaturesAndKeterangan();
    });
    
    window.addEventListener('storage', (event) => {
        if (event.key === 'currentPage') {
            const newPage = localStorage.getItem('currentPage');
            currentPage = newPage;
            updateReportView();
        } else if (event.key === 'displayMode') {
            displayMode = localStorage.getItem('displayMode') || 'two-page';
            updateReportView();
        } else if (event.key && (event.key.includes(currentDivision + '_' + currentGender) || 
                  event.key.includes(currentDivision + '_' + (currentGender === 'Ikhwan' ? 'Akhwat' : 'Ikhwan')))) {
            // Handle division-specific data changes
            if (event.key.includes('attendanceNames')) {
                loadAttendanceNames();
                generateTableRows();
            } else if (event.key.includes('reportTitles') || event.key.includes('attendanceInfo')) {
                loadTitles();
                loadAttendanceInfo();
            } else if (event.key.includes('tanggalPresensi')) {
                setDynamicDate();
            } else if (event.key.includes('spreadsheetData')) {
                loadSignaturesAndKeterangan();
            }
        } else if (event.key === 'currentDivision') {
            // Handle division change from other tabs
            const newDivision = localStorage.getItem('currentDivision') || 'Khusus';
            changeDivision(newDivision);
        } else if (event.key === 'currentGender') {
            // Handle gender change from other tabs
            const newGender = localStorage.getItem('currentGender') || 'Ikhwan';
            changeGender(newGender);
        }
    });
    
    window.addEventListener('namesUpdate', () => {
        console.log('Names updated event received');
        loadAttendanceNames();
        generateTableRows();
    });
    
    window.addEventListener('storageUpdate', () => {
        loadSignaturesAndKeterangan();
    });
    
    // Listen to Firebase auth state changes
    if (window.firebaseAuth) {
        window.addEventListener('authStateChanged', (event) => {
            const { user, isLoggedIn, profile } = event.detail;
            updateLoginUI(isLoggedIn, profile);
        });
    }

    // Save all keterangan before page unload
    window.addEventListener('beforeunload', () => {
        console.log('Saving all keterangan before unload...');
        document.querySelectorAll('.keterangan').forEach(select => {
            const name = select.dataset.name;
            const keterangan = select.value;
            if (name && name.trim() !== '') {
                saveKeterangan(name, keterangan);
            }
        });
    });

    // Setup auto-save for keterangan
    function setupKeteranganAutoSave() {
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('keterangan')) {
                const name = e.target.dataset.name;
                const keterangan = e.target.value;
                if (name && name.trim() !== '') {
                    saveKeterangan(name, keterangan);
                }
            }
        });
    }

    // ========== INITIALIZATION ==========
    function initializePage() {
        console.log('report.js: Initializing application');
        
        // Migrate old data first
        migrateOldData();
        
        // Setup gender selector FIRST
        setupGenderSelector();
        setupDivisionSelector();
        
        // Load division data
        loadDivisionData();
        
        if (rowHeaderNames.length === 0) {
            rowHeaderNames.push('');
            rowHeaderNames.push('');
            saveAttendanceNames();
        } else {
            cleanupTrailingEmptyPairs();
        }
        
        initializeButtonPositions();
        setupHamburgerMenu();
        updateReportView();
        updateActiveDropdownItem();
        checkLoginStatus();
        
        // Setup auto-save for keterangan
        setupKeteranganAutoSave();
        
        setTimeout(() => {
            initializeSwipeGestures();
            console.log('Swipe gestures ready');
            
            // Add modal CSS animations
            if (!document.querySelector('#modal-animations')) {
                const style = document.createElement('style');
                style.id = 'modal-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                    
                    @keyframes modalPop {
                        from { transform: scale(0.9); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                    
                    @keyframes modalPopOut {
                        from { transform: scale(1); opacity: 1; }
                        to { transform: scale(0.9); opacity: 0; }
                    }
                    
                    .signature-wrapper {
                        cursor: none;
                    }
                    
                    .material-symbols-outlined {
                        vertical-align: middle;
                    }
                    
                    /* Login modal styles */
                    .login-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                    }
                    
                    .login-modal {
                        background: white;
                        border-radius: 10px;
                        padding: 30px;
                        width: 90%;
                        max-width: 500px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        position: relative;
                        animation: modalPop 0.3s ease;
                    }
                    
                    .login-modal.show {
                        display: block;
                    }
                    
                    .login-modal-content h3 {
                        margin-top: 0;
                        margin-bottom: 20px;
                        color: var(--text);
                        font-family: 'Poppins', sans-serif;
                        font-weight: 600;
                        text-align: center;
                    }
                    
                    .login-modal-content .firebase-login-subtitle {
                        text-align: center;
                        color: var(--text-light);
                        margin-bottom: 25px;
                        font-size: 14px;
                    }
                    
                    .login-input-group {
                        margin-bottom: 20px;
                    }
                    
                    .login-input {
                        width: 100%;
                        padding: 12px 15px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-family: 'Poppins', sans-serif;
                        font-size: 14px;
                        transition: border-color 0.3s ease;
                    }
                    
                    .login-input:focus {
                        outline: none;
                        border-color: var(--secondary);
                    }
                    
                    .login-password-container {
                        position: relative;
                    }
                    
                    .show-password {
                        position: absolute;
                        right: 10px;
                        top: 50%;
                        transform: translateY(-50%);
                        background: none;
                        border: none;
                        cursor: none;
                        color: #666;
                        padding: 5px;
                    }
                    
                    .login-error {
                        color: #ff6b6b;
                        font-size: 13px;
                        margin: 10px 0;
                        padding: 8px 12px;
                        background: #fff5f5;
                        border-radius: 4px;
                        display: none;
                    }
                    
                    .login-button-group {
                        display: flex;
                        gap: 10px;
                        margin-bottom: 20px;
                    }
                    
                    .login-btn, .register-btn {
                        flex: 1;
                        padding: 12px;
                        border: none;
                        border-radius: 6px;
                        font-family: 'Poppins', sans-serif;
                        font-weight: 500;
                        cursor: none;
                        transition: all 0.3s ease;
                    }
                    
                    .login-btn {
                        background: var(--secondary);
                        color: white;
                    }
                    
                    .login-btn:active {
                        background: var(--secondary);
                    }
                    
                    .register-btn {
                        background: #f0f0f0;
                        color: var(--text);
                    }
                    
                    .register-btn:active {
                        background: #e0e0e0;
                    }
                    
                    .continue-offline {
                        text-align: center;
                        margin-top: 20px;
                        padding-top: 20px;
                        border-top: 1px solid #eee;
                    }
                    
                    .continue-btn {
                        background: transparent;
                        border: 1px solid #ddd;
                        color: var(--text-light);
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: none;
                        font-family: 'Poppins', sans-serif;
                        transition: all 0.3s ease;
                    }
                    
                    .continue-btn:active {
                        background: #f5f5f5;
                        border-color: #ccc;
                    }
                    
                    .login-close-btn {
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: none;
                        color: #666;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
.division-select {
width: 100%;
padding: 8px 12px;
border-radius: 4px;
background: white;
font-family: 'Poppins', sans-serif;
font-size: 13px;
color: var(--text);
cursor: none;
outline: none;
}
                    }
                    
                    /* Login status indicator in dropdown */
                    .dropdown-item.login-button.logged-in {
                        background: var(--secondary);
                        color: white;
                    }
                    
                    .login-user-info {
                        font-size: 12px;
                        opacity: 0.8;
                        margin-top: 3px;
                    }
                    
                    /* Style for login button in dropdown */
                    .login-button .material-symbols-outlined {
                        vertical-align: middle;
                        margin-right: 8px;
                    }
                    
                    /* Make login button positioned at bottom */
                    .dropdown-item.login-button {
                        margin-top: auto;
                        background: white;
                    }
                    
                    .dropdown-item.login-button:active {
                        background: var(--secondary);
                        color: white;
                    }
                    
                    /* Disabled input styles when not logged in */
                    body:not(.user-logged-in) .title-input:not(:focus),
                    body:not(.user-logged-in) .info-input:not(:focus),
                    body:not(.user-logged-in) .name-input:not(:focus),
                    body:not(.user-logged-in) .date-input:not(:focus) {
                        background-color: white;
                        cursor: not-allowed;
                        color: var(--text);
                    }
                    
                    /* Enable signature even when not logged in */
                    .signature-wrapper {
                        cursor: none !important;
                    }
                    
                    body.user-logged-in .title-input:not(:focus),
                    body.user-logged-in .info-input:not(:focus),
                    body.user-logged-in .name-input:not(:focus),
                    body.user-logged-in .date-input:not(:focus) {
                        background-color: white;
                        cursor: none;
                        color: var(--text);
                    }
                    
                    body.user-logged-in .date-input:not(:focus) {
                        font-weight: bold;
                    }
                    
                    body:not(.user-logged-in) .date-input:not(:focus) {
                        font-weight: bold;
                    }
                    
                    .dropdown-section {
                        padding: 12px 16px;
                        background: white;
                    }
                    
                    .dropdown-section-label {
                        font-size: 12px;
                        color: var(--text-light);
                        margin-bottom: 6px;
                        font-weight: 500;
                        font-family: 'Poppins', sans-serif;
                    }
                    
                    .division-toggle-group {
                        display: flex;
                        align-items: center;
                    }
                    
                    .division-select {
                        width: 100%;
                        padding: 8px 12px;
                        border-radius: 4px;
                        background: white;
                        font-family: 'Poppins', sans-serif;
                        font-size: 13px;
                        color: var(--text);
                        cursor: none;
                        outline: none;
                    }
                    
                    /* Auto-save notification styles */
                    #auto-save-notification {
                        transition: all 0.3s ease;
                        font-weight: 500;
                    }
                    
                    @keyframes savePulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.7; }
                        100% { opacity: 1; }
                    }
                    
                    .saving {
                        animation: savePulse 1s infinite;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Force load signatures and keterangan after a delay
            setTimeout(() => {
                loadSignaturesAndKeterangan();
            }, 1000);
        }, 500);
    }

    // Start initialization
    initializePage();
});

// ========== PAPER UPDATE DEBUG FUNCTIONS ==========
function debugPaperUpdate() {
    console.log('=== PAPER UPDATE DEBUG ===');
    
    // Check current state
    const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
    const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
    const namesKey = `${currentDivision}_${currentGender}_attendanceNames`;
    const titlesKey = `${currentDivision}_${currentGender}_reportTitles`;
    const infoKey = `${currentDivision}_${currentGender}_attendanceInfo`;
    
    console.log('1. Current context:', { currentDivision, currentGender });
    console.log('2. Names in localStorage:', JSON.parse(localStorage.getItem(namesKey) || '[]'));
    console.log('3. Titles in localStorage:', JSON.parse(localStorage.getItem(titlesKey) || '[]'));
    console.log('4. Info in localStorage:', JSON.parse(localStorage.getItem(infoKey) || '{}'));
    
    // Check UI elements
    console.log('5. Title inputs:');
    console.log('   - Title 1:', document.getElementById('report-title1')?.value);
    console.log('   - Title 2:', document.getElementById('report-title2')?.value);
    console.log('   - Title 3:', document.getElementById('report-title3')?.value);
    
    console.log('6. Info inputs:');
    console.log('   - Waktu:', document.getElementById('waktu-input')?.value);
    console.log('   - Tempat:', document.getElementById('tempat-input')?.value);
    console.log('   - Keterangan:', document.getElementById('keterangan-input')?.value);
    
    console.log('7. Table rows count:', document.querySelectorAll('#report-table-body tr').length);
    console.log('8. Name inputs count:', document.querySelectorAll('.name-input').length);
    
    return {
        division: currentDivision,
        gender: currentGender,
        names: JSON.parse(localStorage.getItem(namesKey) || '[]'),
        titles: JSON.parse(localStorage.getItem(titlesKey) || '[]'),
        info: JSON.parse(localStorage.getItem(infoKey) || '{}')
    };
}

// Make it globally available
window.debugPaper = debugPaperUpdate;

// ========== GLOBAL FUNCTIONS ==========
// Make functions available globally
window.showLoginModal = showLoginModal;
window.showNotification = showNotification;
window.simpleLogin = simpleLogin;
window.simpleDownload = simpleDownload;
window.addFallbackDownloadButton = addFallbackDownloadButton;

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    // Add fallback download button
    addFallbackDownloadButton();
    
    // Setup sync button
    setTimeout(() => {
        setupSyncButtonDebug();
        
        // Check Firebase status
        console.log('=== FIREBASE STATUS CHECK ===');
        console.log('1. Firebase SDK:', typeof firebase !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded');
        
        if (typeof firebase !== 'undefined') {
            console.log('2. Firebase apps:', firebase.apps.length);
            console.log('3. Firebase services:');
            console.log('   - Firestore:', typeof firebase.firestore);
            console.log('   - Auth:', typeof firebase.auth);
            console.log('   - Storage:', typeof firebase.storage);
            
            // Check current user
            const auth = firebase.auth();
            console.log('4. Auth state:', auth.currentUser ? '‚úÖ Logged in' : '‚ùå Not logged in');
            if (auth.currentUser) {
                console.log('   User:', auth.currentUser.email);
            }
        }
        
        // Check dbManager
        console.log('5. dbManager:', window.dbManager ? '‚úÖ Available' : '‚ùå Not available');
        if (window.dbManager) {
            console.log('   Initialized:', window.dbManager.isInitialized);
            console.log('   Debug logs:', window.dbManager.getDebugLogs ? window.dbManager.getDebugLogs().length : 'N/A');
        }
    }, 2000);
});

// Debug Firebase loading
console.log('=== FIREBASE DEBUG ===');
const checkFirebase = setInterval(() => {
    console.log('Checking Firebase...');
    
    if (typeof firebase !== 'undefined') {
        clearInterval(checkFirebase);
        console.log('‚úÖ Firebase loaded!');
        console.log('Firebase apps:', firebase.apps);
        
        // Initialize if needed
        if (!firebase.apps.length) {
            console.log('üîÑ Initializing Firebase...');
            try {
                const firebaseConfig = {
    apiKey: "AIzaSyDJzfOmhABSBW7b3gciWzw01y0yjaMItRo",
    authDomain: "ami-smaitnh-signature-id.firebaseapp.com",
    projectId: "ami-smaitnh-signature-id",
    storageBucket: "ami-smaitnh-signature-id.firebasestorage.app",
    messagingSenderId: "876171811139",
    appId: "1:876171811139:web:c1b6af6383f3827480f7f6"
};
                firebase.initializeApp(firebaseConfig);
                console.log('‚úÖ Firebase initialized');
            } catch (error) {
                console.error('‚ùå Firebase init error:', error);
            }
        }
        
        // Setup sync button
        setupSyncButtonDebug();
    }
}, 1000);

// Timeout after 10 seconds
setTimeout(() => {
    clearInterval(checkFirebase);
    console.log('‚ùå Firebase loading timeout');
}, 10000);</script>
<script>
// ========== COMPLETE DBMANAGER WITH AUTO-SAVE AND DELETE ==========
console.log('üîÑ Loading complete dbManager...');

// Create dbManager with all required functions
window.dbManager = {
    isInitialized: false,
    _initializationPromise: null,
    _saveQueue: [],
    _deleteQueue: [],
    _processingQueue: false,
    
    // ========== INITIALIZATION ==========
    initialize: async function() {
        console.log('üîÑ Initializing complete dbManager...');
        
        // Return existing promise if already initializing
        if (this._initializationPromise) {
            return this._initializationPromise;
        }
        
        this._initializationPromise = new Promise(async (resolve) => {
            try {
                console.log('Checking Firebase availability...');
                
                // Wait for Firebase to load
                await this.waitForFirebase();
                
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    console.log('‚úÖ Firebase available, initializing services...');
                    
                    try {
                        this.db = firebase.firestore();
                        this.storage = firebase.storage();
                        
                        // Enable persistence
                        try {
                            await firebase.firestore().enablePersistence({
                                synchronizeTabs: true
                            });
                            console.log('‚úÖ Firestore persistence enabled');
                        } catch (persistenceError) {
                            console.warn('‚ö†Ô∏è Firestore persistence failed:', persistenceError);
                        }
                        
                        // Set Firestore settings
                        firebase.firestore().settings({
                            cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                            merge: true
                        });
                        
                        this.isInitialized = true;
                        console.log('‚úÖ Complete dbManager initialized with Firebase');
                        
                        // Process any queued items
                        this.processQueues();
                        
                    } catch (serviceError) {
                        console.warn('‚ö†Ô∏è Firebase services error:', serviceError);
                        console.log('üì¥ Using localStorage only mode');
                        this.isInitialized = true; // Still mark as initialized
                    }
                } else {
                    console.log('üì¥ Firebase not available - using localStorage only');
                    this.isInitialized = true; // Still usable for local storage
                }
                
                resolve(true);
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                this.isInitialized = true; // Still usable
                resolve(true);
            }
        });
        
        return this._initializationPromise;
    },
    
    waitForFirebase: function() {
        return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 10;
            
            const check = () => {
                attempts++;
                
                if (typeof firebase !== 'undefined') {
                    console.log(`‚úÖ Firebase loaded after ${attempts} attempts`);
                    resolve();
                } else if (attempts >= maxAttempts) {
                    console.log(`‚ùå Firebase not loaded after ${maxAttempts} attempts`);
                    resolve(); // Resolve anyway to continue
                } else {
                    setTimeout(check, 500);
                }
            };
            
            check();
        });
    },
    
    // ========== SIGNATURE SAVE FUNCTIONS ==========
// Update saveSignature function in dbManager
saveSignature: async function(name, signatureDataUrl, keterangan) {
        console.log(`üíæ Auto-saving signature for: "${name}"`);
        
        // Get current context
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        const key = `${currentDivision}_${currentGender}_spreadsheetData`;
        
        // 1. Always save to localStorage first (immediate save)
        const localData = JSON.parse(localStorage.getItem(key) || '{}');
        if (!localData[name]) localData[name] = {};
        if (signatureDataUrl) localData[name].image = signatureDataUrl;
        if (keterangan !== undefined) localData[name].keterangan = keterangan;
        localData[name]._lastUpdated = Date.now(); // Add timestamp
        
        localStorage.setItem(key, JSON.stringify(localData));
        console.log(`‚úÖ Saved to localStorage: "${name}"`);
        
        // 2. Try to save to Firebase if available (async, doesn't block)
        const firebaseResult = await this.saveToFirebase(name, signatureDataUrl, keterangan, currentDivision, currentGender);
        
        return {
            success: true,
            savedLocally: true,
            savedToFirebase: firebaseResult.success,
            firebaseError: firebaseResult.error,
            message: 'Signature auto-saved to localStorage' + (firebaseResult.success ? ' and Firebase' : '')
        };
    },
    
    // Update saveToFirebase to include better timestamps
    saveToFirebase: async function(name, signatureDataUrl, keterangan, currentDivision, currentGender) {
        try {
            if (!this.isInitialized) {
                await this.initialize();
            }
            
            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                console.log('üì¥ Firebase not available');
                return { success: false, error: 'Firebase not available' };
            }
            
            // Allow both logged-in and non-logged-in users
            const currentUser = firebase.auth().currentUser;
            let userId = 'anonymous';
            let userEmail = 'anonymous@example.com';
            
            if (currentUser) {
                userId = currentUser.uid;
                userEmail = currentUser.email || 'anonymous@example.com';
            }
            
            console.log(`üì§ Attempting Firebase save for: "${name}" (User: ${userId})`);
            
            // Create unique document ID
            const safeName = name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 100);
            const docId = `${currentDivision}_${currentGender}_${safeName}_${userId}`;
            
            // Prepare data with timestamp
            const firebaseData = {
                name: name.trim(),
                division: currentDivision,
                gender: currentGender,
                keterangan: keterangan || '',
                userId: userId,
                userEmail: userEmail,
                localTimestamp: new Date().toISOString(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                appVersion: '1.0.0',
                isAnonymous: !currentUser,
                _clientTimestamp: Date.now() // Client-side timestamp for conflict resolution
            };
            
            // Handle image if present
            if (signatureDataUrl && signatureDataUrl.startsWith('data:image')) {
                try {
                    firebaseData.signatureDataUrl = signatureDataUrl;
                    firebaseData.hasImage = true;
                    firebaseData.imageSize = signatureDataUrl.length;
                } catch (imageError) {
                    console.warn('‚ö†Ô∏è Image processing failed:', imageError);
                    firebaseData.hasImage = false;
                }
            } else {
                firebaseData.hasImage = false;
            }
            
            // Save to Firestore
            await firebase.firestore()
                .collection('attendance_data')
                .doc(docId)
                .set(firebaseData, { merge: true });
            
            console.log(`‚úÖ Firebase save successful: "${name}" (Doc: ${docId})`);
            
            return { success: true, docId: docId };
            
        } catch (firebaseError) {
            console.warn('‚ö†Ô∏è Firebase save failed:', firebaseError.message);
            
            // Queue for retry
            this.addToSaveQueue({
                name,
                signatureDataUrl,
                keterangan,
                currentDivision,
                currentGender,
                timestamp: Date.now(),
                error: firebaseError.message,
                retryCount: 0
            });
            
            return {
                success: false,
                error: firebaseError.message,
                queuedForRetry: true
            };
        }
    },
    
saveToFirebase: async function(name, signatureDataUrl, keterangan, currentDivision, currentGender) {
    try {
        if (!this.isInitialized) {
            await this.initialize();
        }
        
        if (typeof firebase === 'undefined' || !firebase.apps.length) {
            console.log('üì¥ Firebase not available');
            return { success: false, error: 'Firebase not available' };
        }
        
        // Allow both logged-in and non-logged-in users
        const currentUser = firebase.auth().currentUser;
        let userId = 'anonymous';
        let userEmail = 'anonymous@example.com';
        
        if (currentUser) {
            userId = currentUser.uid;
            userEmail = currentUser.email || 'anonymous@example.com';
        }
        
        console.log(`üì§ Attempting Firebase save for: "${name}" (User: ${userId})`);
        
        // Create unique document ID
        const safeName = name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 100);
        const docId = `${currentDivision}_${currentGender}_${safeName}_${userId}`;
        
        // Prepare data
        const firebaseData = {
            name: name.trim(),
            division: currentDivision,
            gender: currentGender,
            keterangan: keterangan || '',
            userId: userId,
            userEmail: userEmail,
            localTimestamp: new Date().toISOString(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            appVersion: '1.0.0',
            isAnonymous: !currentUser
        };
        
        // Handle image if present
        if (signatureDataUrl && signatureDataUrl.startsWith('data:image')) {
            try {
                firebaseData.signatureDataUrl = signatureDataUrl;
                firebaseData.hasImage = true;
                firebaseData.imageSize = signatureDataUrl.length;
            } catch (imageError) {
                console.warn('‚ö†Ô∏è Image processing failed:', imageError);
                firebaseData.hasImage = false;
            }
        } else {
            firebaseData.hasImage = false;
        }
        
        // Save to Firestore
        await firebase.firestore()
            .collection('attendance_data')
            .doc(docId)
            .set(firebaseData, { merge: true });
        
        console.log(`‚úÖ Firebase save successful: "${name}" (Doc: ${docId})`);
        
        return { success: true, docId: docId };
        
    } catch (firebaseError) {
        console.warn('‚ö†Ô∏è Firebase save failed:', firebaseError.message);
        
        // Queue for retry
        this.addToSaveQueue({
            name,
            signatureDataUrl,
            keterangan,
            currentDivision,
            currentGender,
            timestamp: Date.now(),
            error: firebaseError.message,
            retryCount: 0
        });
        
        return {
            success: false,
            error: firebaseError.message,
            queuedForRetry: true
        };
    }
},
    
    // ========== SIGNATURE DELETE FUNCTIONS ==========
    deleteSignature: async function(name) {
    console.log(`üóëÔ∏è Deleting signature for: "${name}"`);
    
    // Get current context
    const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
    const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
    const key = `${currentDivision}_${currentGender}_spreadsheetData`;
    
    // 1. Delete from localStorage
    const localData = JSON.parse(localStorage.getItem(key) || '{}');
    let deletedLocally = false;
    
    if (localData[name]) {
        // Remove the entire entry
        delete localData[name];
        localStorage.setItem(key, JSON.stringify(localData));
        deletedLocally = true;
        console.log(`‚úÖ Deleted from localStorage: "${name}"`);
    }
    
    // 2. Try to delete from Firebase (signature and name data)
    const firebaseResult = await this.deleteFromFirebase(name, currentDivision, currentGender);
    
    return {
        success: true,
        deletedLocally: deletedLocally,
        deletedFromFirebase: firebaseResult.success || firebaseResult.deletedCount > 0,
        firebaseDeletedCount: firebaseResult.deletedCount || 0,
        firebaseError: firebaseResult.error,
        message: `Name "${name}" deleted from localStorage` +
            (firebaseResult.deletedCount ? ` and ${firebaseResult.deletedCount} Firebase document(s)` : '')
    };
},
    
    deleteFromFirebase: async function(name, currentDivision, currentGender) {
    try {
        if (!this.isInitialized) {
            await this.initialize();
        }
        
        if (typeof firebase === 'undefined' || !firebase.apps.length) {
            console.log('üì¥ Firebase not available');
            return { success: false, error: 'Firebase not available' };
        }
        
        console.log(`üóëÔ∏è Attempting Firebase delete for: "${name}" from ${currentDivision}_${currentGender}`);
        
        // Get all possible document IDs for this name (supports both logged-in and anonymous users)
        let userIds = ['anonymous'];
        const currentUser = firebase.auth().currentUser;
        if (currentUser) {
            userIds.push(currentUser.uid);
        }
        
        let deletedCount = 0;
        let errorCount = 0;
        
        // Try to delete documents for each possible user ID
        for (const userId of userIds) {
            const safeName = name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 100);
            const docId = `${currentDivision}_${currentGender}_${safeName}_${userId}`;
            
            try {
                const docRef = firebase.firestore().collection('attendance_data').doc(docId);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    await docRef.delete();
                    deletedCount++;
                    console.log(`‚úÖ Deleted Firebase document: ${docId}`);
                } else {
                    console.log(`‚ÑπÔ∏è Document not found: ${docId}`);
                }
            } catch (deleteError) {
                errorCount++;
                console.warn(`‚ö†Ô∏è Failed to delete document ${docId}:`, deleteError.message);
            }
        }
        
        // Also search for documents with this name (case-insensitive search)
        try {
            const querySnapshot = await firebase.firestore()
                .collection('attendance_data')
                .where('name', '==', name.trim())
                .where('division', '==', currentDivision)
                .where('gender', '==', currentGender)
                .get();
            
            for (const doc of querySnapshot.docs) {
                try {
                    await doc.ref.delete();
                    deletedCount++;
                    console.log(`‚úÖ Deleted by query: ${doc.id}`);
                } catch (error) {
                    errorCount++;
                    console.warn(`‚ö†Ô∏è Failed to delete by query:`, error.message);
                }
            }
        } catch (queryError) {
            console.warn(`‚ö†Ô∏è Query search failed:`, queryError.message);
        }
        
        return {
            success: deletedCount > 0,
            deletedCount: deletedCount,
            errorCount: errorCount,
            message: `Deleted ${deletedCount} Firebase document(s)`
        };
        
    } catch (firebaseError) {
        console.warn('‚ö†Ô∏è Firebase delete failed:', firebaseError.message);
        
        // Queue for retry
        this.addToDeleteQueue({
            name,
            currentDivision,
            currentGender,
            timestamp: Date.now(),
            error: firebaseError.message,
            retryCount: 0
        });
        
        return {
            success: false,
            error: firebaseError.message,
            queuedForRetry: true
        };
    }
},

deleteNameFromFirebase: async function(name, currentDivision, currentGender) {
    console.log(`üóëÔ∏è Deleting name "${name}" from Firebase...`);
    
    // Also delete associated signatures and keterangan
    const deleteResult = await this.deleteFromFirebase(name, currentDivision, currentGender);
    
    return {
        success: deleteResult.success || deleteResult.deletedCount > 0,
        deletedCount: deleteResult.deletedCount || 0,
        message: deleteResult.message || 'Name deletion completed'
    };
},
    
    // ========== QUEUE MANAGEMENT ==========
    addToSaveQueue: function(item) {
        this._saveQueue.push(item);
        
        // Keep only last 50 items
        if (this._saveQueue.length > 50) {
            this._saveQueue.shift();
        }
        
        localStorage.setItem('dbManager_save_queue', JSON.stringify(this._saveQueue));
        console.log(`üìã Added to save queue. Total: ${this._saveQueue.length}`);
        
        // Start processing if not already
        if (!this._processingQueue) {
            this.processQueues();
        }
    },
    
    addToDeleteQueue: function(item) {
        this._deleteQueue.push(item);
        
        // Keep only last 50 items
        if (this._deleteQueue.length > 50) {
            this._deleteQueue.shift();
        }
        
        localStorage.setItem('dbManager_delete_queue', JSON.stringify(this._deleteQueue));
        console.log(`üìã Added to delete queue. Total: ${this._deleteQueue.length}`);
        
        // Start processing if not already
        if (!this._processingQueue) {
            this.processQueues();
        }
    },
    
    processQueues: async function() {
        if (this._processingQueue || (!this._saveQueue.length && !this._deleteQueue.length)) {
            return;
        }
        
        this._processingQueue = true;
        console.log(`üîÑ Processing queues (Save: ${this._saveQueue.length}, Delete: ${this._deleteQueue.length})`);
        
        try {
            // Process save queue
            const failedSaves = [];
            for (const item of this._saveQueue) {
                try {
                    await this.saveToFirebase(
                        item.name,
                        item.signatureDataUrl,
                        item.keterangan,
                        item.currentDivision,
                        item.currentGender
                    );
                    console.log(`‚úÖ Retry successful for save: "${item.name}"`);
                } catch (error) {
                    item.retryCount = (item.retryCount || 0) + 1;
                    if (item.retryCount < 3) {
                        failedSaves.push(item);
                    } else {
                        console.log(`‚ùå Giving up on save for "${item.name}" after ${item.retryCount} attempts`);
                    }
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // Delay between retries
            }
            
            // Process delete queue
            const failedDeletes = [];
            for (const item of this._deleteQueue) {
                try {
                    await this.deleteFromFirebase(
                        item.name,
                        item.currentDivision,
                        item.currentGender
                    );
                    console.log(`‚úÖ Retry successful for delete: "${item.name}"`);
                } catch (error) {
                    item.retryCount = (item.retryCount || 0) + 1;
                    if (item.retryCount < 3) {
                        failedDeletes.push(item);
                    } else {
                        console.log(`‚ùå Giving up on delete for "${item.name}" after ${item.retryCount} attempts`);
                    }
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // Delay between retries
            }
            
            // Update queues
            this._saveQueue = failedSaves;
            this._deleteQueue = failedDeletes;
            
            localStorage.setItem('dbManager_save_queue', JSON.stringify(this._saveQueue));
            localStorage.setItem('dbManager_delete_queue', JSON.stringify(this._deleteQueue));
            
            console.log(`‚úÖ Queue processing complete. Failed: Save=${failedSaves.length}, Delete=${failedDeletes.length}`);
            
        } catch (error) {
            console.error('‚ùå Queue processing error:', error);
        } finally {
            this._processingQueue = false;
            
            // Schedule next processing if there are still items
            if (this._saveQueue.length > 0 || this._deleteQueue.length > 0) {
                setTimeout(() => this.processQueues(), 30000); // Retry in 30 seconds
            }
        }
    },
    
    // ========== UTILITY FUNCTIONS ==========
    testConnection: async function() {
        console.log('üß™ Testing connection...');
        
        const result = {
            localStorage: true,
            firebaseAvailable: typeof firebase !== 'undefined',
            firebaseInitialized: false,
            firestoreAvailable: false,
            authAvailable: false,
            currentUser: null,
            dbManagerInitialized: this.isInitialized
        };
        
        try {
            // Test localStorage
            localStorage.setItem('dbManager_test', 'test');
            localStorage.removeItem('dbManager_test');
            
            // Test Firebase if available
            if (typeof firebase !== 'undefined') {
                result.firebaseInitialized = firebase.apps.length > 0;
                
                if (firebase.apps.length > 0) {
                    result.firestoreAvailable = !!firebase.firestore;
                    result.authAvailable = !!firebase.auth;
                    
                    // Test Firestore write if user is logged in
                    const currentUser = firebase.auth().currentUser;
                    if (currentUser) {
                        result.currentUser = {
                            email: currentUser.email,
                            uid: currentUser.uid
                        };
                        
                        try {
                            const testRef = firebase.firestore().collection('connection_tests').doc('test_' + Date.now());
                            await testRef.set({
                                test: true,
                                timestamp: new Date().toISOString(),
                                user: currentUser.email
                            }, { merge: true });
                            result.firestoreWrite = true;
                        } catch (writeError) {
                            result.firestoreWrite = false;
                            result.firestoreWriteError = writeError.message;
                        }
                    }
                }
            }
            
            console.log('‚úÖ Connection test complete:', result);
            return {
                success: true,
                data: result
            };
            
        } catch (error) {
            console.error('‚ùå Connection test failed:', error);
            return {
                success: false,
                error: error.message,
                data: result
            };
        }
    },
    
    syncAllLocalData: async function() {
        console.log('üîÑ Syncing all local data to Firebase...');
        
        try {
            // Get all local data
            const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
            const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
            const key = `${currentDivision}_${currentGender}_spreadsheetData`;
            
            const data = JSON.parse(localStorage.getItem(key) || '{}');
            const names = Object.keys(data);
            
            console.log(`Found ${names.length} items to sync`);
            
            let successCount = 0;
            let errorCount = 0;
            
            // Sync in batches
            for (let i = 0; i < names.length; i++) {
                const name = names[i];
                
                try {
                    const signatureDataUrl = data[name]?.image || '';
                    const keterangan = data[name]?.keterangan || '';
                    
                    const result = await this.saveToFirebase(name, signatureDataUrl, keterangan, currentDivision, currentGender);
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                    
                    // Delay between saves to prevent quota issues
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    errorCount++;
                    console.error(`‚ùå Error syncing "${name}":`, error);
                }
            }
            
            const message = `‚úÖ Sync complete: ${successCount} successful, ${errorCount} failed`;
            console.log(message);
            
            return {
                success: true,
                total: names.length,
                successful: successCount,
                failed: errorCount,
                message: message
            };
            
        } catch (error) {
            console.error('‚ùå Sync all data failed:', error);
            return {
                success: false,
                error: error.message
            };
        }
    },
    
    getStatus: function() {
        return {
            isInitialized: this.isInitialized,
            firebaseAvailable: typeof firebase !== 'undefined',
            firebaseApps: firebase?.apps?.length || 0,
            currentUser: firebase?.auth()?.currentUser,
            saveQueueLength: this._saveQueue.length,
            deleteQueueLength: this._deleteQueue.length,
            processingQueue: this._processingQueue
        };
    },
    
    clearQueues: function() {
        this._saveQueue = [];
        this._deleteQueue = [];
        localStorage.removeItem('dbManager_save_queue');
        localStorage.removeItem('dbManager_delete_queue');
        console.log('üßπ Cleared all queues');
        return { success: true, message: 'Queues cleared' };
    },
    
    // ========== COMPLETE DATA SYNC FUNCTIONS ==========

// Add to your existing dbManager object
saveNames: async function(names, currentDivision, currentGender) {
        try {
            console.log('üíæ Saving names to Firebase...', names.length, 'names');
            
            if (!this.isInitialized) {
                await this.initialize();
            }
            
            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                console.log('üì¥ Firebase not available');
                return { success: false, error: 'Firebase not available' };
            }
            
            // Get user ID
            const currentUser = firebase.auth().currentUser;
            let userId = 'anonymous';
            let userEmail = 'anonymous@example.com';
            
            if (currentUser) {
                userId = currentUser.uid;
                userEmail = currentUser.email || 'anonymous@example.com';
            }
            
            // Create document ID
            const docId = `${currentDivision}_${currentGender}_names_${userId}`;
            
            const namesData = {
                names: names,
                division: currentDivision,
                gender: currentGender,
                userId: userId,
                userEmail: userEmail,
                count: names.filter(n => n && n.trim()).length,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await firebase.firestore()
                .collection('attendance_names')
                .doc(docId)
                .set(namesData, { merge: true });
            
            console.log('‚úÖ Names saved to Firebase');
            return { success: true, docId: docId };
            
        } catch (error) {
            console.error('‚ùå Error saving names:', error);
            return { success: false, error: error.message };
        }
    },
    
    saveTitles: async function(titles, currentDivision, currentGender) {
            try {
                console.log('üíæ Saving titles to Firebase...', titles);
                
                if (!this.isInitialized) {
                    await this.initialize();
                }
                
                if (typeof firebase === 'undefined' || !firebase.apps.length) {
                    console.log('üì¥ Firebase not available');
                    return { success: false, error: 'Firebase not available' };
                }
                
                // Get user ID
                const currentUser = firebase.auth().currentUser;
                let userId = 'anonymous';
                let userEmail = 'anonymous@example.com';
                
                if (currentUser) {
                    userId = currentUser.uid;
                    userEmail = currentUser.email || 'anonymous@example.com';
                }
                
                // Create document ID
                const docId = `${currentDivision}_${currentGender}_titles_${userId}`;
                
                const titleData = {
                    titles: titles,
                    division: currentDivision,
                    gender: currentGender,
                    userId: userId,
                    userEmail: userEmail,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await firebase.firestore()
                    .collection('attendance_titles')
                    .doc(docId)
                    .set(titleData, { merge: true });
                
                console.log('‚úÖ Titles saved to Firebase:', titles);
                return { success: true, docId: docId };
                
            } catch (error) {
                console.error('‚ùå Error saving titles:', error);
                return { success: false, error: error.message };
            }
        },
        
        saveInfo: async function(infoData, currentDivision, currentGender) {
                try {
                    console.log('üíæ Saving info to Firebase...', infoData);
                    
                    if (!this.isInitialized) {
                        await this.initialize();
                    }
                    
                    if (typeof firebase === 'undefined' || !firebase.apps.length) {
                        console.log('üì¥ Firebase not available');
                        return { success: false, error: 'Firebase not available' };
                    }
                    
                    // Get user ID
                    const currentUser = firebase.auth().currentUser;
                    let userId = 'anonymous';
                    let userEmail = 'anonymous@example.com';
                    
                    if (currentUser) {
                        userId = currentUser.uid;
                        userEmail = currentUser.email || 'anonymous@example.com';
                    }
                    
                    // Create document ID
                    const docId = `${currentDivision}_${currentGender}_info_${userId}`;
                    
                    const infoDocument = {
                        ...infoData,
                        division: currentDivision,
                        gender: currentGender,
                        userId: userId,
                        userEmail: userEmail,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await firebase.firestore()
                        .collection('attendance_info')
                        .doc(docId)
                        .set(infoDocument, { merge: true });
                    
                    console.log('‚úÖ Info saved to Firebase:', infoData);
                    return { success: true, docId: docId };
                    
                } catch (error) {
                    console.error('‚ùå Error saving info:', error);
                    return { success: false, error: error.message };
                }
            },
            
            saveDate: async function(dateValue, currentDivision, currentGender) {
                try {
                    console.log('üíæ Saving date to Firebase...', dateValue);
                    
                    if (!this.isInitialized) {
                        await this.initialize();
                    }
                    
                    if (typeof firebase === 'undefined' || !firebase.apps.length) {
                        console.log('üì¥ Firebase not available');
                        return { success: false, error: 'Firebase not available' };
                    }
                    
                    // Get user ID
                    const currentUser = firebase.auth().currentUser;
                    let userId = 'anonymous';
                    let userEmail = 'anonymous@example.com';
                    
                    if (currentUser) {
                        userId = currentUser.uid;
                        userEmail = currentUser.email || 'anonymous@example.com';
                    }
                    
                    // Create document ID
                    const docId = `${currentDivision}_${currentGender}_date_${userId}`;
                    
                    const dateData = {
                        date: dateValue,
                        division: currentDivision,
                        gender: currentGender,
                        userId: userId,
                        userEmail: userEmail,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await firebase.firestore()
                        .collection('attendance_dates')
                        .doc(docId)
                        .set(dateData, { merge: true });
                    
                    console.log('‚úÖ Date saved to Firebase:', dateValue);
                    return { success: true, docId: docId };
                    
                } catch (error) {
                    console.error('‚ùå Error saving date:', error);
                    return { success: false, error: error.message };
                }
            },
    
    // Helper to convert data URL to blob (if needed for storage upload)
    dataURLtoBlob: function(dataURL) {
        try {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            
            return new Blob([u8arr], { type: mime });
        } catch (error) {
            console.error('Error converting dataURL to blob:', error);
            return new Blob();
        }
    }
};

console.log('‚úÖ Complete dbManager created with auto-save and delete functions');

// Load queues from localStorage
try {
    window.dbManager._saveQueue = JSON.parse(localStorage.getItem('dbManager_save_queue') || '[]');
    window.dbManager._deleteQueue = JSON.parse(localStorage.getItem('dbManager_delete_queue') || '[]');
    console.log(`üìã Loaded queues: Save=${window.dbManager._saveQueue.length}, Delete=${window.dbManager._deleteQueue.length}`);
} catch (error) {
    console.warn('‚ö†Ô∏è Error loading queues:', error);
}

// Auto-initialize
setTimeout(() => {
    window.dbManager.initialize().then(() => {
        console.log('üöÄ Complete dbManager initialization complete');
        console.log('Status:', window.dbManager.getStatus());
    });
}, 1000);

// Export for debugging
window.debugDbManager = function() {
    console.log('=== DB MANAGER DEBUG ===');
    console.log('1. dbManager exists:', !!window.dbManager);
    console.log('2. dbManager.isInitialized:', window.dbManager.isInitialized);
    console.log('3. Firebase loaded:', typeof firebase !== 'undefined');
    
    if (typeof firebase !== 'undefined') {
        console.log('4. Firebase apps:', firebase.apps.length);
        console.log('5. Firebase auth:', !!firebase.auth);
        console.log('6. Firebase firestore:', !!firebase.firestore);
        console.log('7. Current user:', firebase.auth().currentUser);
    }
    
    console.log('8. Queues:', {
        save: window.dbManager._saveQueue.length,
        delete: window.dbManager._deleteQueue.length,
        processing: window.dbManager._processingQueue
    });
    
    console.log('9. LocalStorage check:');
    const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
    const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
    const key = `${currentDivision}_${currentGender}_spreadsheetData`;
    const data = JSON.parse(localStorage.getItem(key) || '{}');
    console.log(`   - Key: ${key}`);
    console.log(`   - Items in storage: ${Object.keys(data).length}`);
    
    return window.dbManager.getStatus();
};
</script>
<script>
    // Diagnostic check for Firebase status
    console.log('=== FIREBASE DIAGNOSTIC CHECK ===');
    console.log('1. Firebase SDK loaded:', typeof firebase !== 'undefined');
    console.log('2. Firebase apps count:', firebase?.apps?.length || 0);
    console.log('3. Firebase services available:');
    console.log('   - Auth:', typeof firebase?.auth);
    console.log('   - Firestore:', typeof firebase?.firestore);
    console.log('   - Storage:', typeof firebase?.storage);
    console.log('4. Firebase config loaded:', window.firebaseInitialized || false);
    console.log('5. dbManager initialized:', window.dbManager?.isInitialized || false);
    console.log('6. firebaseAuth initialized:', window.firebaseAuth?.isInitialized || false);
    console.log('7. Current user in auth:', firebase?.auth()?.currentUser);
    console.log('8. Local user:', JSON.parse(localStorage.getItem('currentUser') || 'null'));
    
    // Test Firestore permissions
    async function testFirestorePermissions() {
        if (typeof firebase !== 'undefined' && firebase.apps.length) {
            try {
                const testRef = firebase.firestore().collection('test_permissions').doc('diagnostic_test');
                await testRef.set({
                    test: true,
                    timestamp: new Date().toISOString(),
                    diagnostic: true
                }, { merge: true });
                console.log('‚úÖ Firestore write permission: GRANTED');
                
                const doc = await testRef.get();
                console.log('‚úÖ Firestore read permission: GRANTED');
                
            } catch (error) {
                console.error('‚ùå Firestore permission error:', error.code, error.message);
                
                if (error.code === 'permission-denied') {
                    console.log('üîí PERMISSION DENIED - Check Firebase Firestore security rules');
                    console.log('Go to: https://console.firebase.google.com/project/jwr-khwan/firestore/rules');
                    console.log('Recommended rules:');
                    console.log(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read/write data
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
                `);
                }
            }
        }
    }
    
    // Run test
    setTimeout(testFirestorePermissions, 2000);
</script>
</html>